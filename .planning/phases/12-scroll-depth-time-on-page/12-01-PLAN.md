---
phase: 12-scroll-depth-time-on-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/useNessusTracking.ts
autonomous: true

must_haves:
  truths:
    - "Scroll milestones (25/50/75/90/100%) fire exactly once per page load as user scrolls down"
    - "Short pages (content < viewport height) do not fire scroll events"
    - "Scroll events are sent to Nessus CRM with event_name='scroll_depth', page_path at top level, and event_data containing percent_scrolled"
    - "Page navigation remains performant with no degradation from tracking overhead"
  artifacts:
    - path: "hooks/useNessusTracking.ts"
      provides: "Scroll depth tracking via IntersectionObserver"
      contains: "IntersectionObserver"
  key_links:
    - from: "useScrollDepth (inside useNessusTracking.ts)"
      to: "trackEvent"
      via: "calls trackEvent('scroll_depth', { percent_scrolled }) with page_path from closure"
      pattern: "trackEvent.*scroll_depth.*percent_scrolled"
---

<objective>
Add scroll depth tracking to the Shrike website's useNessusTracking hook.

Purpose: Capture scroll milestone events (25/50/75/90/100%) so the CRM dashboard can show which pages users actually read vs bounce from. Uses IntersectionObserver with sentinel elements for performant, off-main-thread detection.

Output: Updated useNessusTracking.ts that automatically tracks scroll depth on every page that uses the hook.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

IMPORTANT: This plan operates on the SHRIKE WEBSITE repo, NOT the Nessus CRM repo.
Working directory: C:\Users\steph\OneDrive\Desktop\claude\shrike

The tracking hook file:
@C:\Users\steph\OneDrive\Desktop\claude\shrike\hooks\useNessusTracking.ts

Research findings:
@.planning/phases/12-scroll-depth-time-on-page/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scroll depth tracking to useNessusTracking</name>
  <files>C:\Users\steph\OneDrive\Desktop\claude\shrike\hooks\useNessusTracking.ts</files>
  <action>
Add a scroll depth tracking effect inside the existing `useNessusTracking` hook. This is NOT a separate hook file -- add it as a second `useEffect` inside the existing function body, after the page view effect and before the `return { trackEvent }`.

Implementation details:

1. Add a new `useEffect` that sets up IntersectionObserver-based scroll tracking:

2. Short page guard: Check `document.documentElement.scrollHeight <= window.innerHeight + 100`. If true, skip tracking entirely (page is already fully visible, scroll milestones are meaningless).

3. Create sentinel elements at 25%, 50%, 75%, 90%, 100% depth using PIXEL positioning:
   - Calculate: `const pixelTop = (percent / 100) * document.documentElement.scrollHeight`
   - Style: `position: absolute; top: ${pixelTop}px; height: 1px; width: 1px; pointer-events: none; visibility: hidden;`
   - Do NOT use CSS percentage (top: 25%) â€” body may lack position: relative, making % unreliable
   - Append each sentinel to `document.body`
   - Add a data attribute for identification: `data-scroll-sentinel="true"`

4. Duplicate prevention: Use a `Set<number>` to track which milestones have fired. Check `!fired.has(percent)` before calling trackEvent. Add to Set immediately after firing.

5. For each sentinel, create an IntersectionObserver with `{ threshold: 0 }`. On intersection (`entry.isIntersecting`), fire: `trackEvent('scroll_depth', { percent_scrolled: percent })`
   - Note: page_path is already included by trackEvent's closure over pagePath, so do NOT add page_path to event_data (it would be redundant with the top-level page_path field sent by trackEvent).

6. Cleanup function must:
   - Disconnect all observers: `observers.forEach(obs => obs.disconnect())`
   - Remove all sentinel elements: `sentinels.forEach(el => el.remove())`

7. Dependencies array: `[pagePath, trackEvent]` -- re-setup when page changes.

8. Do NOT create a separate file or separate hook. Keep everything inside useNessusTracking.ts as a self-contained useEffect block.

Avoid:
- Do NOT use scroll event listeners (addEventListener('scroll')). IntersectionObserver is more performant.
- Do NOT use percentage-based CSS positioning (top: 25%) -- body lacks position: relative, so % would be relative to viewport, not page height.
- Do NOT send page_path in event_data -- it's already sent as a top-level field by the trackEvent function.
  </action>
  <verify>
1. Read the updated file and confirm: IntersectionObserver is used (not scroll listeners), Set is used for deduplication, cleanup disconnects observers and removes sentinels, short page guard exists.
2. Run TypeScript compilation check from the Shrike repo root:
   ```
   cd C:\Users\steph\OneDrive\Desktop\claude\shrike && npx tsc --noEmit
   ```
   Should pass with no errors.
3. Run build check:
   ```
   cd C:\Users\steph\OneDrive\Desktop\claude\shrike && npm run build
   ```
   Should complete successfully.
  </verify>
  <done>
  - useNessusTracking.ts contains a scroll depth useEffect with IntersectionObserver
  - 5 milestones tracked (25/50/75/90/100%) with Set-based dedup
  - Short page guard skips tracking when content < viewport
  - Cleanup removes sentinels and disconnects observers
  - TypeScript compiles and build succeeds
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd C:\Users\steph\OneDrive\Desktop\claude\shrike && npx tsc --noEmit`
2. Build succeeds: `cd C:\Users\steph\OneDrive\Desktop\claude\shrike && npm run build`
3. Code review: IntersectionObserver used (not scroll), Set dedup present, cleanup present, short page guard present
</verification>

<success_criteria>
- useNessusTracking.ts has scroll depth tracking that fires exactly once per milestone per page load
- Short pages are excluded from tracking
- No memory leaks (observers disconnected, sentinels removed on unmount)
- TypeScript compiles and production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/12-scroll-depth-time-on-page/12-01-SUMMARY.md`

Git commit in Shrike repo (NOT Nessus repo):
```
cd C:\Users\steph\OneDrive\Desktop\claude\shrike
git add hooks/useNessusTracking.ts
git commit -m "feat(tracking): add scroll depth tracking via IntersectionObserver"
```
</output>
