---
phase: 03-sync-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/contexts/SyncContext.tsx
  - crm-dashboard/components/SyncStatusIndicator.tsx
  - crm-dashboard/app/(dashboard)/layout.tsx
  - crm-dashboard/app/(dashboard)/settings/toast/page.tsx
autonomous: true

must_haves:
  truths:
    - "Orders sync automatically every 60 seconds without user action"
    - "Sync status indicator shows last sync time"
    - "Sync status indicator shows in-progress spinner"
    - "Rate limited responses trigger exponential backoff"
    - "Manual sync button remains functional on settings page"
  artifacts:
    - path: "crm-dashboard/contexts/SyncContext.tsx"
      provides: "Global sync state management"
      exports: ["SyncProvider", "useSyncStatus"]
    - path: "crm-dashboard/components/SyncStatusIndicator.tsx"
      provides: "Visual sync status display"
      exports: ["SyncStatusIndicator"]
  key_links:
    - from: "crm-dashboard/contexts/SyncContext.tsx"
      to: "/api/toast/sync"
      via: "fetch in performSync"
      pattern: "fetch.*api/toast/sync"
    - from: "crm-dashboard/app/(dashboard)/layout.tsx"
      to: "crm-dashboard/contexts/SyncContext.tsx"
      via: "SyncProvider wrapper"
      pattern: "<SyncProvider>"
    - from: "crm-dashboard/components/SyncStatusIndicator.tsx"
      to: "crm-dashboard/contexts/SyncContext.tsx"
      via: "useSyncStatus hook"
      pattern: "useSyncStatus"
---

<objective>
Implement automatic background sync for Toast orders with status indicator and rate limit handling.

Purpose: Users currently must manually trigger Toast sync from settings page. Automatic polling ensures orders stay up-to-date without user intervention.

Output: SyncContext provider with polling, SyncStatusIndicator component, integrated into dashboard layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sync-automation/03-RESEARCH.md

# Key existing files
@crm-dashboard/contexts/UserContext.tsx
@crm-dashboard/app/(dashboard)/layout.tsx
@crm-dashboard/app/(dashboard)/settings/toast/page.tsx
@crm-dashboard/app/api/toast/sync/route.ts
@crm-dashboard/app/(dashboard)/visits/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncContext with auto-polling</name>
  <files>crm-dashboard/contexts/SyncContext.tsx</files>
  <action>
Create SyncContext.tsx following the UserContext.tsx pattern already in the codebase.

Interface:
```typescript
interface SyncContextType {
  status: 'idle' | 'syncing' | 'success' | 'error' | 'rate-limited'
  lastSyncAt: string | null
  error: string | null
  syncNow: () => Promise<void>  // Manual trigger
}
```

Implementation requirements:
1. Poll every 60 seconds using setInterval (proven pattern in visits/page.tsx)
2. Only poll if admin (check isAdmin from UserContext) AND currentClientId is set
3. Use isSyncingRef to prevent concurrent syncs (common pitfall from RESEARCH.md)
4. Handle 429 responses with exponential backoff:
   - Check Retry-After header first (Toast provides it)
   - Fallback: Math.min(1000 * Math.pow(2, attempt), 32000) + jitter
   - Reset attempt counter on success
5. Pause polling when document.hidden (visibilitychange event)
6. Persist lastSyncAt to localStorage for display across page navigations
7. SSR-safe: Check typeof window !== 'undefined' before localStorage access
8. Cleanup: Return clearInterval from useEffect

Exports: SyncProvider, useSyncStatus

Do NOT use external libraries - the codebase uses native fetch/setInterval patterns.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd crm-dashboard && npx tsc --noEmit
```
  </verify>
  <done>
SyncContext.tsx exists with SyncProvider and useSyncStatus exports. Polling starts when admin has client selected, stops when tab hidden, handles rate limits with backoff.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SyncStatusIndicator and wire into layout</name>
  <files>
crm-dashboard/components/SyncStatusIndicator.tsx
crm-dashboard/app/(dashboard)/layout.tsx
  </files>
  <action>
Create SyncStatusIndicator.tsx component:
1. Use useSyncStatus() hook to get sync state
2. Show different states:
   - syncing: Spinner + "Syncing..."
   - success: Green checkmark + "Last synced X mins ago" (use relative time formatting)
   - error: Red warning + error message
   - rate-limited: Yellow warning + "Rate limited, retrying..."
   - idle: Gray text "Auto-sync active" (when client selected) or nothing (when no client)
3. Position: Small inline component suitable for sidebar footer or header
4. Style: Match existing Tailwind patterns (text-sm, text-gray-400, flex items-center gap-2)

For relative time, calculate inline:
```typescript
const getRelativeTime = (date: string) => {
  const seconds = Math.floor((Date.now() - new Date(date).getTime()) / 1000)
  if (seconds < 60) return 'just now'
  const minutes = Math.floor(seconds / 60)
  if (minutes < 60) return `${minutes}m ago`
  const hours = Math.floor(minutes / 60)
  return `${hours}h ago`
}
```

Update layout.tsx:
1. Import SyncProvider from @/contexts/SyncContext
2. Wrap UserProvider children with SyncProvider (inside UserProvider so it can use useUser)
3. Import and place SyncStatusIndicator in sidebar, above the Sign Out button
4. Only render SyncStatusIndicator for admins (isAdmin check)
  </action>
  <verify>
1. TypeScript compiles: `cd crm-dashboard && npx tsc --noEmit`
2. Dev server starts: `cd crm-dashboard && npm run dev` (should load without errors)
  </verify>
  <done>
SyncStatusIndicator shows sync status in sidebar. Indicator updates when sync runs. Spinner visible during sync, relative time shown after success.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Toast settings to use SyncContext</name>
  <files>crm-dashboard/app/(dashboard)/settings/toast/page.tsx</files>
  <action>
Update toast settings page to use SyncContext for the manual sync button:

1. Import useSyncStatus from @/contexts/SyncContext
2. Replace local syncing state with context:
   - Remove: const [syncing, setSyncing] = useState(false)
   - Add: const { status, syncNow } = useSyncStatus()
   - Replace syncing boolean with: status === 'syncing'
3. Update handleSync to call syncNow() from context instead of direct fetch
4. Remove the duplicate fetch logic - context handles it all
5. Keep the success message display (context sync updates integration status in DB)
6. After sync, refresh integration status by re-fetching from /api/toast/setup

The Integration Status section already shows last_sync_at and last_sync_status from the database. Keep that - it will update after each sync.

Keep the manual "Sync Now" button with same styling, just wire it to context.
  </action>
  <verify>
1. TypeScript compiles: `cd crm-dashboard && npx tsc --noEmit`
2. Navigate to /settings/toast, select a client with integration
3. Click "Sync Now" - should trigger sync via context
4. Status indicator in sidebar should update
  </verify>
  <done>
Manual sync button on settings page triggers context sync. Status indicator reflects sync in progress. No duplicate sync logic.
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. **Auto-sync works:**
   - Login as admin, select a client with Toast integration
   - Open browser DevTools Network tab
   - Wait 60+ seconds, observe /api/toast/sync requests firing automatically

2. **Status indicator updates:**
   - When sync fires, spinner appears in sidebar
   - After sync completes, "Last synced X ago" appears

3. **Manual sync still works:**
   - Go to /settings/toast, select client with integration
   - Click "Sync Now" button
   - Verify sync runs and indicator updates

4. **Rate limit handling:**
   - Not easily testable manually, but code review should confirm:
     - 429 response checks Retry-After header
     - Exponential backoff with jitter applied
     - Attempt counter resets on success

5. **Tab visibility:**
   - Open orders page, switch to another tab for 2+ minutes
   - No sync requests should fire while tab hidden
   - Return to tab, sync should resume
</verification>

<success_criteria>
- [ ] Orders sync automatically every 60 seconds when admin has client selected
- [ ] Sync status indicator visible in sidebar showing last sync time
- [ ] Spinner displays during active sync
- [ ] Rate limited responses handled with backoff (no error spam)
- [ ] Manual sync button on settings page still functional
- [ ] Polling pauses when tab is hidden
- [ ] TypeScript compiles without errors
- [ ] Dev server runs without console errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-sync-automation/03-01-SUMMARY.md`
</output>
