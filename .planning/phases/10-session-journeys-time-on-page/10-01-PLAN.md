---
phase: 10-session-journeys-time-on-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/app/(dashboard)/analytics/components/sections/SessionJourneys.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/TimeOnPage.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Deep Dive tab and see session journey data instead of Coming Soon placeholder"
    - "User can see chronological event sequences grouped by session with timestamps and page paths"
    - "User can see which sessions had the most events and how long they lasted"
    - "User can see average time spent on each page across all sessions"
    - "User can see time-on-page metrics that correctly exclude last-page-in-session (no duration available)"
    - "Site filter (All Sites / Press Club / Rosemont) applies to both Deep Dive sections"
  artifacts:
    - path: "crm-dashboard/app/(dashboard)/analytics/components/sections/SessionJourneys.tsx"
      provides: "Session journey visualization grouped by session_id"
      exports: ["SessionJourneys"]
    - path: "crm-dashboard/app/(dashboard)/analytics/components/sections/TimeOnPage.tsx"
      provides: "Time on page aggregation by page_path"
      exports: ["TimeOnPage"]
    - path: "crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx"
      provides: "Tab container rendering Deep Dive sections"
      contains: "SessionJourneys"
  key_links:
    - from: "ShrikeAnalytics.tsx"
      to: "SessionJourneys.tsx"
      via: "import and render in Deep Dive tab branch"
      pattern: "import.*SessionJourneys"
    - from: "ShrikeAnalytics.tsx"
      to: "TimeOnPage.tsx"
      via: "import and render in Deep Dive tab branch"
      pattern: "import.*TimeOnPage"
    - from: "SessionJourneys.tsx"
      to: "shared/types.ts"
      via: "Visit interface import"
      pattern: "import.*Visit.*from.*types"
    - from: "TimeOnPage.tsx"
      to: "date-fns"
      via: "differenceInSeconds for time delta calculation"
      pattern: "differenceInSeconds"
---

<objective>
Build two Deep Dive analytics sections — SessionJourneys and TimeOnPage — and wire them into the ShrikeAnalytics Deep Dive tab, replacing the "Coming Soon" placeholder.

Purpose: Surface session-level visitor insights that show HOW users navigate the site (event sequences per session) and WHERE they spend time (average page durations), completing the first two v1.3 Analytics Deep Dive requirements.

Output: Two new section components in the Deep Dive tab showing real analytics computed from existing visit data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 9 established the section component pattern this phase extends
@.planning/phases/09-component-decomposition/09-01-SUMMARY.md

# Research for this phase — patterns, pitfalls, code examples
@.planning/phases/10-session-journeys-time-on-page/10-RESEARCH.md

# Key source files to reference during implementation
@crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx
@crm-dashboard/app/(dashboard)/analytics/components/shared/types.ts
@crm-dashboard/app/(dashboard)/analytics/components/shared/constants.ts
@crm-dashboard/app/(dashboard)/analytics/components/shared/StatCard.tsx
@crm-dashboard/app/(dashboard)/analytics/components/shared/BreakdownCard.tsx
@crm-dashboard/app/(dashboard)/analytics/components/sections/EngagementOverview.tsx
@crm-dashboard/app/(dashboard)/analytics/components/sections/DeviceBrowserOS.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionJourneys section component</name>
  <files>crm-dashboard/app/(dashboard)/analytics/components/sections/SessionJourneys.tsx</files>
  <action>
Create SessionJourneys.tsx following the exact section component pattern from Phase 9.

**Component signature:** `export function SessionJourneys({ visits }: { visits: Visit[] })`

**Computation (useMemo):**
1. Group visits by session_id using a Map (skip visits where session_id is null)
2. Sort events within each session chronologically by created_at
3. Sort sessions by start time, most recent first
4. For each session compute: event count, page count (where event_name is null), session duration (first to last event timestamp), start time

**Rendering:**
- Section wrapper: `bg-white rounded-lg shadow p-6 mb-8` with h2 "Session Journeys"
- Show summary stats at top using StatCard (total sessions, avg events per session, avg session duration)
- Show expandable session list (show most recent 10 by default, with "Show more" if needed)
- Each session card shows:
  - Session start time formatted with date-fns `format` (e.g., "Feb 15, 2:34 PM")
  - Duration (formatted as Xm Ys)
  - Event count badge
  - Chronological event list inside the card:
    - Each event shows: timestamp (time only, e.g., "2:34:12 PM"), page_path OR formatted event_name (use formatEventName from shared/constants.ts for events), and a colored dot using getEventColor for events or a gray dot for page views
- If no sessions have data, show "No session data available" message

**Imports:** Visit from shared/types, formatEventName and getEventColor from shared/constants, StatCard from shared/StatCard, format from date-fns, differenceInSeconds from date-fns, useMemo and useState from react.

**Key rules:**
- Page views have event_name === null; events have event_name populated
- Filter out visits with null session_id before grouping
- ALWAYS sort by created_at within session before rendering
- Use date-fns `format` for display, `differenceInSeconds` for duration
- Format duration as helper function: `const formatDuration = (seconds: number) => { const m = Math.floor(seconds / 60); const s = seconds % 60; return m > 0 ? \`${m}m ${s}s\` : \`${s}s\` }`
  </action>
  <verify>
Run `cd crm-dashboard && npx tsc --noEmit` — no type errors.
Verify the file exports SessionJourneys function.
Verify it imports Visit, formatEventName, getEventColor, StatCard.
Verify useMemo wraps the computation.
  </verify>
  <done>SessionJourneys.tsx exists, exports a named function component that groups visits by session, renders chronological event timelines per session with summary stats, and compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create TimeOnPage section component</name>
  <files>crm-dashboard/app/(dashboard)/analytics/components/sections/TimeOnPage.tsx</files>
  <action>
Create TimeOnPage.tsx following the exact section component pattern from Phase 9.

**Component signature:** `export function TimeOnPage({ visits }: { visits: Visit[] })`

**Computation (useMemo):**
1. Group visits by session_id using a Map (skip null session_id)
2. Sort events within each session chronologically by created_at
3. For each session, iterate consecutive pairs of events:
   - Only calculate duration for page views (where current.event_name is null AND current.page_path is not null)
   - Duration = differenceInSeconds(next.created_at, current.created_at)
   - Skip durations > 1800 seconds (30 min cap — likely abandoned tab)
   - Accumulate durations per page_path into a Map<string, number[]> (array of individual durations)
   - CRITICAL: Skip the last event in each session (no next timestamp to calculate from)
4. Compute per-page stats: average time, total samples (number of measured page views), median time
5. Sort by average time descending

**Rendering:**
- Section wrapper: `bg-white rounded-lg shadow p-6 mb-8` with h2 "Time on Page"
- Subtitle/note below heading: "Based on page transition timing. Last page in each session excluded (no exit timestamp)." in text-sm text-gray-500
- Show overall stats using StatCard row: total pages measured, overall average time on page, total page view samples
- Show per-page breakdown as a table or list:
  - Page path (cleaned: remove trailing slashes, show "/" as "Home")
  - Average time (formatted as Xm Ys or Xs)
  - Sample count
  - Use a horizontal bar to visualize relative time (longest page = 100% width bar, others proportional), colored teal
- If no time data available, show "Not enough session data to calculate time on page" message

**Imports:** Visit from shared/types, StatCard from shared/StatCard, differenceInSeconds from date-fns, useMemo from react.

**Key rules:**
- ONLY compute time for page views (event_name === null), NOT for interaction events
- Never compute time deltas across session boundaries — group by session FIRST
- Cap at 30 minutes (1800 seconds) per page view to exclude abandoned tabs
- The last page in every session has NO duration — skip it, document in UI
- Use the same duration formatter as SessionJourneys (can inline or duplicate — keep it simple)
  </action>
  <verify>
Run `cd crm-dashboard && npx tsc --noEmit` — no type errors.
Verify the file exports TimeOnPage function.
Verify it imports differenceInSeconds from date-fns.
Verify the 1800-second cap is implemented.
Verify last-page exclusion logic is present (loop to length - 1).
  </verify>
  <done>TimeOnPage.tsx exists, exports a named function component that computes average time spent per page from session timestamp deltas, excludes last page and abandoned tabs, renders a sorted breakdown with visual bars, and compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Wire Deep Dive sections into ShrikeAnalytics tab container</name>
  <files>crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx</files>
  <action>
Modify ShrikeAnalytics.tsx to replace the "Coming Soon" placeholder in the Deep Dive tab with the two new section components.

**Changes:**

1. Add imports at top (after existing section imports):
   ```
   import { SessionJourneys } from './sections/SessionJourneys'
   import { TimeOnPage } from './sections/TimeOnPage'
   ```

2. Replace the entire Deep Dive else branch (lines 120-126, the div with "Coming Soon" h2 and p):
   ```tsx
   <>
     <SessionJourneys visits={visits} />
     <TimeOnPage visits={visits} />
   </>
   ```

That is the entire change. Do NOT modify the Overview tab content, the site filter, the tab bar, or the data fetching logic. The tab container pattern means sections receive visits and compute independently.

**Verify no other changes needed:** The existing Supabase query already selects session_id, created_at, page_path, event_name — all fields needed by both new sections. No query changes required.
  </action>
  <verify>
Run `cd crm-dashboard && npx tsc --noEmit` — no type errors.
Run `cd crm-dashboard && npm run build` — build succeeds.
Verify ShrikeAnalytics.tsx imports SessionJourneys and TimeOnPage.
Verify the "Coming Soon" placeholder is gone.
Verify Overview tab content is unchanged.
  </verify>
  <done>ShrikeAnalytics Deep Dive tab renders SessionJourneys and TimeOnPage sections instead of placeholder. Build passes. Overview tab unchanged. Site filter applies to both tabs via shared visits state.</done>
</task>

</tasks>

<verification>
1. `cd crm-dashboard && npm run build` passes with zero errors
2. Deep Dive tab renders two sections (SessionJourneys, TimeOnPage) instead of "Coming Soon"
3. Overview tab renders identically to before (no regression)
4. Both new sections follow the Visit[] -> useMemo -> render pattern
5. Site filter (All Sites / Press Club / Rosemont) affects Deep Dive content (since both sections compute from the same filtered visits array)
6. No new npm dependencies installed
</verification>

<success_criteria>
- SessionJourneys.tsx shows chronological event timelines grouped by session with summary stats
- TimeOnPage.tsx shows average page durations computed from session timestamp deltas with 30-min cap and last-page exclusion
- Deep Dive tab is functional (no more placeholder)
- Build passes, no type errors
- Both sections are autonomous (compute from raw visits via useMemo)
</success_criteria>

<output>
After completion, create `.planning/phases/10-session-journeys-time-on-page/10-01-SUMMARY.md`
</output>
