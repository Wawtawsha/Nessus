---
phase: 09-component-decomposition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/EngagementOverview.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/DownloadMetrics.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/TopPhotos.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/FeatureUsage.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/EngagementFunnel.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/ActivityTimeline.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/PageDistribution.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/DeviceBrowserOS.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/shared/StatCard.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/shared/BreakdownCard.tsx
autonomous: true

must_haves:
  truths:
    - "ShrikeAnalytics.tsx is under 120 lines (tab container + data fetch only)"
    - "Each section component renders identically to the current monolith output"
    - "Overview and Deep Dive tabs exist, with all 8 existing sections on Overview"
    - "Deep Dive tab is empty placeholder ready for phases 10-12"
    - "StatCard and BreakdownCard are shared components used from one location"
    - "Zero visual regression — pixel-identical output on Overview tab"
  artifacts:
    - path: "crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx"
      provides: "Thin tab container: data fetch, site filter, tab toggle, section rendering"
    - path: "crm-dashboard/app/(dashboard)/analytics/components/sections/"
      provides: "8 section components, each owning its own computation from raw visits"
    - path: "crm-dashboard/app/(dashboard)/analytics/components/shared/StatCard.tsx"
      provides: "Shared stat card component"
    - path: "crm-dashboard/app/(dashboard)/analytics/components/shared/BreakdownCard.tsx"
      provides: "Shared breakdown bar chart component"
---

<objective>
Decompose ShrikeAnalytics.tsx (606 lines, 11 state vars) into a thin tab container + 8 section components + 2 shared components. Add Overview/Deep Dive tab layout. Zero visual regression.

Purpose: Unblock phases 10-12 by creating the section component pattern and tab layout that new analytics features plug into.
Output: ShrikeAnalytics.tsx reduced to ~100 lines. 8 section files. 2 shared files. Identical visual output.
</objective>

<context>
@crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx
@crm-dashboard/app/(dashboard)/analytics/page.tsx
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared components (StatCard, BreakdownCard, formatEventName)</name>
  <files>
    crm-dashboard/app/(dashboard)/analytics/components/shared/StatCard.tsx,
    crm-dashboard/app/(dashboard)/analytics/components/shared/BreakdownCard.tsx
  </files>
  <action>
  Extract from ShrikeAnalytics.tsx lines 548-599:

  **StatCard.tsx:**
  - Move the StatCard function component (lines 548-563)
  - Export as named export
  - Keep same props interface: `{ label: string; value: number | string; color: string }`
  - Unify with analytics/page.tsx StatCard — use the fuller color map (include gray, yellow from page.tsx + teal from Shrike)

  **BreakdownCard.tsx:**
  - Move the BreakdownCard function component (lines 565-599)
  - Export the BreakdownItem interface alongside it
  - Export as named export

  Also export `formatEventName` (line 601-605) and `EVENT_CATEGORIES` + `getEventColor` from a shared constants location. Simplest approach: put them at the top of FeatureUsage.tsx since that's the only section that uses EVENT_CATEGORIES for the bar colors, but export formatEventName from a shared spot since FeatureUsage section needs it.

  Actually, simplest: keep EVENT_CATEGORIES, getEventColor, formatEventName, and parseUA as exports in a `shared/constants.ts` file. They're used by multiple sections.
  </action>
  <verify>
  Import StatCard and BreakdownCard from new locations in ShrikeAnalytics.tsx temporarily. Confirm build passes: `npx next build` from crm-dashboard/.
  </verify>
  <done>StatCard.tsx and BreakdownCard.tsx exist as shared components. Constants exported from shared/constants.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Extract section components from ShrikeAnalytics</name>
  <files>
    crm-dashboard/app/(dashboard)/analytics/components/sections/EngagementOverview.tsx,
    crm-dashboard/app/(dashboard)/analytics/components/sections/DownloadMetrics.tsx,
    crm-dashboard/app/(dashboard)/analytics/components/sections/TopPhotos.tsx,
    crm-dashboard/app/(dashboard)/analytics/components/sections/FeatureUsage.tsx,
    crm-dashboard/app/(dashboard)/analytics/components/sections/EngagementFunnel.tsx,
    crm-dashboard/app/(dashboard)/analytics/components/sections/ActivityTimeline.tsx,
    crm-dashboard/app/(dashboard)/analytics/components/sections/PageDistribution.tsx,
    crm-dashboard/app/(dashboard)/analytics/components/sections/DeviceBrowserOS.tsx
  </files>
  <action>
  Each section component follows this pattern:
  - Receives `visits` array as prop (the raw visit data)
  - Computes its own derived state from visits using useMemo
  - Renders its own JSX
  - No useState needed — useMemo from visits prop is sufficient

  The Visit type for props:
  ```typescript
  export interface Visit {
    event_name: string | null
    event_data: any
    session_id: string | null
    page_path: string | null
    created_at: string
    user_agent: string | null
  }
  ```
  Export this from shared/types.ts.

  **Section extraction mapping:**

  1. **EngagementOverview.tsx** — Section 1 (lines 163-176 computation, 346-356 JSX)
     - Computes: pageViews, uniqueSessions, totalInteractions, avgInteractionsPerSession
     - Renders: 4 StatCards in a grid

  2. **DownloadMetrics.tsx** — Section 2 (lines 179-189 computation, 359-369 JSX)
     - Computes: instantDownloads, uniquePhotos, queueOpens, emailSubmissions
     - Renders: 4 StatCards in a grid

  3. **TopPhotos.tsx** — Section 3 (lines 192-210 computation, 372-397 JSX)
     - Computes: photo download ranking from event_data
     - Renders: ranked list in white card

  4. **FeatureUsage.tsx** — Section 4 (lines 213-223 computation, 399-429 JSX)
     - Computes: event counts grouped by event_name
     - Renders: bar chart list with EVENT_CATEGORIES colors

  5. **EngagementFunnel.tsx** — Section 5 (lines 226-236 computation, 432-467 JSX)
     - Computes: funnel steps (sessions -> promo -> lead form -> submit)
     - Renders: horizontal funnel bars with dropoff %

  6. **ActivityTimeline.tsx** — Section 6 (lines 239-260 computation, 469-509 JSX)
     - Computes: daily event counts for last 30 days
     - Renders: Recharts BarChart (keeps recharts imports)

  7. **PageDistribution.tsx** — Section 7 (lines 263-273 computation, 511-536 JSX)
     - Computes: page view counts by page_path
     - Renders: bar chart list

  8. **DeviceBrowserOS.tsx** — Section 9 (lines 277-302 computation, 539-543 JSX)
     - Computes: device/browser/OS breakdown from user_agent using parseUA
     - Renders: 3 BreakdownCards in a grid

  Each component is self-contained. No cross-section dependencies.
  </action>
  <verify>
  Confirm each file compiles. Each component should accept `{ visits: Visit[] }` and render the same output as before.
  </verify>
  <done>8 section components exist, each computing from raw visits and rendering its section.</done>
</task>

<task type="auto">
  <name>Task 3: Rewrite ShrikeAnalytics as tab container</name>
  <files>crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx</files>
  <action>
  Gut ShrikeAnalytics.tsx and replace with:

  1. **State:** Only 3 state vars — `siteFilter`, `loading`, `visits` (raw array), `activeTab`
  2. **Data fetch:** Single Supabase query (same as current), stores raw visits in state
  3. **Site filter UI:** Same toggle buttons (All Sites / Press Club / Rosemont)
  4. **Tab bar:** Simple two-tab toggle: Overview | Deep Dive
     - Use same visual pattern as site filter (pill-style toggle)
     - Below the header, above the sections
  5. **Overview tab:** Render all 8 section components, passing `visits` as prop
  6. **Deep Dive tab:** Render placeholder: "Coming soon — session journeys, referrer analysis, geographic distribution"
  7. **Layout:** Keep exact same section ordering and spacing (mb-8 gaps, grid layouts)

  The component should be ~100-120 lines max.

  **Important:** The `addFilters` helper stays in ShrikeAnalytics since it's the data-fetching layer. Section components never fetch — they only compute and render.
  </action>
  <verify>
  Run `npx next build` from crm-dashboard/. Open the app, select Shrike client, go to Analytics. Verify:
  - Site filter works (All Sites / Press Club / Rosemont)
  - All 8 sections render identically to before
  - Overview tab is active by default
  - Deep Dive tab shows placeholder
  - No console errors
  </verify>
  <done>ShrikeAnalytics.tsx is a thin ~100-line tab container. All sections render from section components. Visual output is identical to pre-refactor.</done>
</task>

<task type="auto">
  <name>Task 4: Update analytics/page.tsx StatCard to use shared component</name>
  <files>crm-dashboard/app/(dashboard)/analytics/page.tsx</files>
  <action>
  The DefaultAnalytics component in page.tsx (lines 557-581) has its own StatCard that duplicates the shared one. Replace it:
  - Import StatCard from '../components/shared/StatCard'
  - Delete the local StatCard function
  - Verify the color map covers all colors used by DefaultAnalytics (gray, blue, yellow, green, purple, indigo)
  </action>
  <verify>
  Run `npx next build`. Switch to a non-Shrike client and verify the DefaultAnalytics page still renders correctly with StatCards.
  </verify>
  <done>Single StatCard definition shared across both analytics views.</done>
</task>

</tasks>

<verification>
- `npx next build` passes with zero errors
- ShrikeAnalytics.tsx is under 120 lines
- 8 section component files exist in sections/
- 2 shared component files + types + constants exist in shared/
- Overview tab shows all 8 sections identically to pre-refactor
- Deep Dive tab shows placeholder text
- Site filter (All/Press Club/Rosemont) still works
- DefaultAnalytics page still works with shared StatCard
</verification>

<success_criteria>
1. ShrikeAnalytics is a thin tab container (under 120 lines)
2. Each section component owns its computation (useMemo from visits prop)
3. Zero visual regression on Overview tab
4. Deep Dive tab exists as empty placeholder for phases 10-12
5. StatCard and BreakdownCard shared across both analytics views
6. Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-component-decomposition/09-01-SUMMARY.md`
</output>
