---
phase: 14-schema-niche-taxonomy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/supabase/migrations/07_scripts_niches_outcomes.sql
  - crm-dashboard/types/niche.ts
  - crm-dashboard/types/lead.ts
autonomous: true

must_haves:
  truths:
    - "niches table exists with UNIQUE lowercase-normalized name column"
    - "scripts table exists with client_id FK, is_active soft delete, and RLS policies"
    - "script_lead_outcomes table exists with UNIQUE(script_id, lead_id) and RLS policies"
    - "leads table has niche_id column (nullable) with FK to niches ON DELETE SET NULL"
    - "All three new tables have RLS enabled with SELECT policies for authenticated users"
    - "Niche type definition exists with id, name, created_at"
    - "Lead interface includes niche_id: string | null"
    - "Existing leads page still loads without errors after migration"
  artifacts:
    - path: "crm-dashboard/supabase/migrations/07_scripts_niches_outcomes.sql"
      provides: "Database schema for niches, scripts, script_lead_outcomes; niche_id on leads"
      contains: "CREATE TABLE niches"
    - path: "crm-dashboard/types/niche.ts"
      provides: "Niche TypeScript interface"
      exports: ["Niche"]
    - path: "crm-dashboard/types/lead.ts"
      provides: "Lead interface extended with niche_id"
      contains: "niche_id"
  key_links:
    - from: "crm-dashboard/supabase/migrations/07_scripts_niches_outcomes.sql"
      to: "leads table"
      via: "ALTER TABLE leads ADD COLUMN niche_id"
      pattern: "ALTER TABLE leads.*niche_id"
    - from: "crm-dashboard/types/lead.ts"
      to: "crm-dashboard/supabase/migrations/07_scripts_niches_outcomes.sql"
      via: "Type mirrors database column"
      pattern: "niche_id.*string.*null"
---

<objective>
Create the foundational database schema for scripts, niches, and outcomes, plus update TypeScript types.

Purpose: This migration creates all three tables needed for v1.4 Cold Calling Scripts in a single transaction. Only the niches table and leads.niche_id are used in this phase, but scripts and script_lead_outcomes are created now to avoid fragmented migrations later.

Output: SQL migration file applied to Supabase, updated type definitions ready for UI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-schema-niche-taxonomy/14-RESEARCH.md

# Source files being modified
@crm-dashboard/types/lead.ts
@crm-dashboard/supabase/migrations/06_cold_calling_client.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration and apply to Supabase</name>
  <files>crm-dashboard/supabase/migrations/07_scripts_niches_outcomes.sql</files>
  <action>
Create the migration file `crm-dashboard/supabase/migrations/07_scripts_niches_outcomes.sql` following the exact pattern from `06_cold_calling_client.sql` (header comment block with purpose, tables, changes, rollback strategy, then BEGIN/COMMIT transaction with step-by-step comments).

The migration must create these objects in this order:

**Step 1: niches table (global taxonomy)**
- `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
- `name TEXT NOT NULL UNIQUE`
- `created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()`
- CHECK constraints: `niche_name_not_empty CHECK (char_length(trim(name)) > 0)`, `niche_name_lowercase CHECK (name = lower(name))`, `niche_name_length CHECK (char_length(name) <= 100)`
- Index: `idx_niches_name ON niches(name)`
- RLS enabled with policies: `niches_select` (SELECT, authenticated, USING true), `niches_insert` (INSERT, authenticated, WITH CHECK true), `niches_delete` (DELETE, authenticated, USING true)
- NO UPDATE policy needed -- niches are immutable names (create or delete, not rename)

**Step 2: scripts table (client-scoped)**
- `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
- `client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE`
- `title TEXT NOT NULL` with CHECK `scripts_title_not_empty CHECK (char_length(trim(title)) > 0)`
- `body TEXT NOT NULL DEFAULT ''`
- `is_active BOOLEAN NOT NULL DEFAULT true` (soft delete)
- `created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()`
- `updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()`
- `created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL`
- Index: `idx_scripts_client_id ON scripts(client_id)`
- RLS enabled. Policies scope to user's clients via user_clients join:
  - SELECT: `scripts_select` using `EXISTS (SELECT 1 FROM user_clients uc WHERE uc.client_id = scripts.client_id AND uc.user_id = auth.uid())`
  - INSERT: `scripts_insert` with check using same user_clients join on `client_id`
  - UPDATE: `scripts_update` using same pattern
  - DELETE: `scripts_delete` using same pattern

**Step 3: script_lead_outcomes table**
- `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
- `script_id UUID NOT NULL REFERENCES scripts(id) ON DELETE CASCADE`
- `lead_id UUID NOT NULL REFERENCES leads(id) ON DELETE CASCADE`
- `outcome TEXT NOT NULL` with CHECK `outcome_valid CHECK (outcome IN ('success', 'fail'))`
- `notes TEXT`
- `created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()`
- `created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL`
- UNIQUE constraint: `unique_script_lead UNIQUE (script_id, lead_id)`
- Indexes: `idx_slo_script_id ON script_lead_outcomes(script_id)`, `idx_slo_lead_id ON script_lead_outcomes(lead_id)`
- RLS enabled. Policies scope through scripts -> user_clients:
  - SELECT: `slo_select` using `EXISTS (SELECT 1 FROM scripts s JOIN user_clients uc ON uc.client_id = s.client_id WHERE s.id = script_lead_outcomes.script_id AND uc.user_id = auth.uid())`
  - INSERT: `slo_insert` with check using same join pattern
  - UPDATE: `slo_update` using same pattern
  - DELETE: `slo_delete` using same pattern

**Step 4: Add niche_id to leads table**
- `ALTER TABLE leads ADD COLUMN niche_id UUID REFERENCES niches(id) ON DELETE SET NULL`
- Index: `idx_leads_niche_id ON leads(niche_id)`

After creating the file, apply the migration to Supabase using the Supabase SQL Editor or CLI. Run the SQL directly against the database:

```bash
cd crm-dashboard
npx supabase db push
```

If `supabase db push` is not configured or errors, copy the SQL content and run it via `npx supabase` CLI or instruct that it needs manual application via Supabase Dashboard SQL Editor.

**Critical things to NOT do:**
- Do NOT use ON DELETE CASCADE for niches -> leads (would delete leads when niche removed). Use ON DELETE SET NULL.
- Do NOT forget the SELECT policy on any table (most common RLS mistake -- queries return empty results).
- Do NOT create an UPDATE policy for niches (niches are create-or-delete, not editable).
  </action>
  <verify>
1. Read the migration file and verify: all 3 tables present, all CHECK constraints present, all RLS policies present (especially SELECT), niche_id on leads with ON DELETE SET NULL, all indexes created.
2. Run `npm run build` in crm-dashboard to confirm no TypeScript compilation errors (should pass since types haven't changed yet -- but confirms no accidental breakage).
3. If migration was applied: query `SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('niches', 'scripts', 'script_lead_outcomes')` to confirm tables exist.
  </verify>
  <done>
Migration file exists at `crm-dashboard/supabase/migrations/07_scripts_niches_outcomes.sql` with all three tables, RLS policies (including SELECT on every table), CHECK constraints for niche name (lowercase, not empty, max 100 chars), indexes on all foreign keys, and niche_id nullable column on leads with ON DELETE SET NULL.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript type definitions</name>
  <files>crm-dashboard/types/niche.ts, crm-dashboard/types/lead.ts</files>
  <action>
**Create `crm-dashboard/types/niche.ts`:**
```typescript
export interface Niche {
  id: string
  name: string
  created_at: string
}
```

That's it -- minimal interface matching the database table. No LeadWithNiche extension needed; the join result will be typed inline where used.

**Modify `crm-dashboard/types/lead.ts`:**
Add `niche_id: string | null` to the Lead interface. Insert it after the `social_media_presence` field (keeping qualification fields grouped together). The field MUST be `string | null` (explicitly nullable) because all existing leads will have `niche_id = NULL` after migration.

Do NOT add a `niche` nested object to the Lead interface. The join result (`niche: { name: string } | null`) will be handled with a separate type or inline typing in the UI plan where the Supabase join query is used.

**Why nullable is critical:** All existing leads in the database have no niche. If we typed this as `string` (non-null), every existing query that returns Lead[] would cause TypeScript errors or runtime crashes when accessing `lead.niche_id`.
  </action>
  <verify>
1. Run `cd crm-dashboard && npx tsc --noEmit` to confirm no TypeScript errors.
2. Verify `types/niche.ts` exports the Niche interface.
3. Verify `types/lead.ts` has `niche_id: string | null` in the Lead interface.
4. Run `npm run build` to confirm the app still builds successfully (existing pages using Lead type should not break since niche_id is nullable and optional in practice).
  </verify>
  <done>
`types/niche.ts` exists with Niche interface (id, name, created_at). `types/lead.ts` Lead interface includes `niche_id: string | null`. App builds without errors. Existing leads page loads without TypeScript compilation failures.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists and follows the established pattern (header, BEGIN/COMMIT, step comments)
2. All three tables have RLS enabled with at minimum a SELECT policy
3. niches table has all three CHECK constraints (not empty, lowercase, max 100 chars) + UNIQUE on name
4. leads table has niche_id with ON DELETE SET NULL (NOT CASCADE)
5. scripts table has is_active for soft delete
6. script_lead_outcomes has UNIQUE(script_id, lead_id) for upsert pattern
7. TypeScript types match database schema
8. `npm run build` passes in crm-dashboard
</verification>

<success_criteria>
- Migration file `07_scripts_niches_outcomes.sql` exists with all 4 steps (niches, scripts, outcomes, leads ALTER)
- All tables have RLS policies including SELECT
- `types/niche.ts` exports Niche interface
- `types/lead.ts` includes `niche_id: string | null`
- `npm run build` succeeds
- Migration applied to Supabase (or documented as needing manual application)
</success_criteria>

<output>
After completion, create `.planning/phases/14-schema-niche-taxonomy/14-01-SUMMARY.md`
</output>
