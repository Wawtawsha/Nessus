---
phase: 14-schema-niche-taxonomy
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - crm-dashboard/components/ui/command.tsx
  - crm-dashboard/components/NicheComboBox.tsx
  - crm-dashboard/app/(dashboard)/leads/page.tsx
  - crm-dashboard/app/(dashboard)/leads/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees a Niche column in the leads table showing the assigned niche name or a dash"
    - "User can filter leads by niche using a dropdown in the filter bar"
    - "User can select or create a niche when adding a new lead via the Add Lead dialog"
    - "User can change a lead's niche when editing on the lead detail page"
    - "Typing a name that does not exist shows a Create button to inline-create the niche"
    - "Newly created niches appear immediately in the combo selector without page refresh"
    - "Clearing filters resets the niche filter too"
  artifacts:
    - path: "crm-dashboard/components/ui/command.tsx"
      provides: "shadcn Command component (cmdk wrapper)"
      exports: ["Command", "CommandInput", "CommandEmpty", "CommandGroup", "CommandItem"]
    - path: "crm-dashboard/components/NicheComboBox.tsx"
      provides: "Searchable combo selector with inline niche creation"
      exports: ["NicheComboBox"]
      min_lines: 50
    - path: "crm-dashboard/app/(dashboard)/leads/page.tsx"
      provides: "Leads list with niche column, niche filter, niche in Add Lead dialog"
      contains: "niche"
    - path: "crm-dashboard/app/(dashboard)/leads/[id]/page.tsx"
      provides: "Lead detail with niche in edit mode"
      contains: "niche_id"
  key_links:
    - from: "crm-dashboard/components/NicheComboBox.tsx"
      to: "supabase niches table"
      via: "fetch and insert queries"
      pattern: "from\\('niches'\\)"
    - from: "crm-dashboard/app/(dashboard)/leads/page.tsx"
      to: "crm-dashboard/components/NicheComboBox.tsx"
      via: "import in Add Lead dialog"
      pattern: "import.*NicheComboBox"
    - from: "crm-dashboard/app/(dashboard)/leads/page.tsx"
      to: "supabase niches table"
      via: "join query for niche name display"
      pattern: "select\\('\\*, niche:niches\\(name\\)'\\)"
    - from: "crm-dashboard/app/(dashboard)/leads/[id]/page.tsx"
      to: "crm-dashboard/components/NicheComboBox.tsx"
      via: "import in edit mode"
      pattern: "import.*NicheComboBox"
---

<objective>
Build the NicheComboBox component and integrate niche selection across the leads list page (table column, filter, Add Lead dialog) and lead detail page (edit mode).

Purpose: Users need to categorize leads by business niche for the Cold Calling workflow. This enables filtering leads by niche and later analyzing script performance per niche (Phase 17).

Output: Working niche combo selector, leads table with niche column and filter, niche field in Add Lead and Edit Lead flows.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-schema-niche-taxonomy/14-RESEARCH.md
@.planning/phases/14-schema-niche-taxonomy/14-01-SUMMARY.md

# Source files being modified
@crm-dashboard/app/(dashboard)/leads/page.tsx
@crm-dashboard/app/(dashboard)/leads/[id]/page.tsx
@crm-dashboard/components/ui/popover.tsx
@crm-dashboard/types/niche.ts
@crm-dashboard/types/lead.ts
@crm-dashboard/lib/utils.ts
@crm-dashboard/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn Command component and create NicheComboBox</name>
  <files>crm-dashboard/components/ui/command.tsx, crm-dashboard/components/NicheComboBox.tsx</files>
  <action>
**Step 1: Install cmdk dependency.**

The project has no `components.json` (shadcn was set up manually). Install cmdk directly:

```bash
cd crm-dashboard
npm install cmdk@1
```

Note: Use cmdk v1.x (the latest major version). The shadcn Command component wraps cmdk.

**Step 2: Create `crm-dashboard/components/ui/command.tsx`.**

Create the shadcn Command component manually following the same pattern as the existing `popover.tsx` (imports from primitive library, wraps with cn() styling, re-exports). The Command component wraps cmdk.

The component should export: `Command`, `CommandDialog`, `CommandInput`, `CommandList`, `CommandEmpty`, `CommandGroup`, `CommandItem`, `CommandSeparator`, `CommandShortcut`.

Follow the official shadcn command component source: https://ui.shadcn.com/docs/components/command

Key implementation notes:
- Import from `cmdk` (not `@radix-ui/react-command` -- cmdk is the actual package)
- Use `cn()` from `@/lib/utils` for className merging
- CommandInput should have a search icon from lucide-react (Search icon)
- Apply Tailwind classes matching the project's gray-based color scheme (not slate or zinc)

**Step 3: Create `crm-dashboard/components/NicheComboBox.tsx`.**

Build a combobox using the Popover + Command pattern. Props interface:

```typescript
interface NicheComboBoxProps {
  value: string | null       // selected niche ID
  onChange: (nicheId: string | null) => void  // callback when selection changes
}
```

Behavior:
1. On mount, fetch all niches from Supabase: `supabase.from('niches').select('*').order('name')`
2. Display as a Button trigger (Popover) showing selected niche name or "Select niche..."
3. On open, show Command with search input
4. Filter niches by typed search value (cmdk handles filtering automatically)
5. Include a "(None)" option at the top that sets value to null
6. **Inline creation:** When CommandEmpty renders (no matching niches), show a button: `Create "searchValue"`. On click:
   - Normalize: `searchValue.toLowerCase().trim()`
   - Insert into niches table
   - Handle unique constraint violation (error code `23505`) by finding the existing niche
   - Add new niche to local state, select it, close popover
7. Show checkmark icon next to currently selected niche

Use `createClient` from `@/lib/supabase/client` for Supabase queries (same pattern as leads/page.tsx).

Import Niche type from `@/types/niche`.

**Things to NOT do:**
- Do NOT use react-hook-form or zod here (save for future phases). This is a controlled component with simple value/onChange props.
- Do NOT make the component server-side -- it must be `'use client'` since it uses useState, useEffect, and Supabase client.
- Do NOT hardcode niche options. They come from the database.
  </action>
  <verify>
1. Confirm `cmdk` is in package.json dependencies.
2. Run `npx tsc --noEmit` in crm-dashboard -- no TypeScript errors.
3. Verify `command.tsx` exports Command, CommandInput, CommandEmpty, CommandGroup, CommandItem, CommandList.
4. Verify `NicheComboBox.tsx` imports from `@/components/ui/command` and `@/components/ui/popover`.
5. Run `npm run build` to confirm the app builds.
  </verify>
  <done>
`cmdk` installed. `components/ui/command.tsx` exists with all shadcn Command exports. `components/NicheComboBox.tsx` exists as a controlled Popover+Command combobox that fetches niches from Supabase, supports search/filter, inline creation, and a "(None)" clear option.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate niche into leads list page (column, filter, Add Lead dialog)</name>
  <files>crm-dashboard/app/(dashboard)/leads/page.tsx</files>
  <action>
Modify `crm-dashboard/app/(dashboard)/leads/page.tsx` with these four changes:

**Change 1: Update query to join niche data.**

Change the leads query from `select('*')` to `select('*, niche:niches(name)')`. This uses Supabase's foreign key join to include the niche name in each lead row. The result type for each lead will have an additional `niche: { name: string } | null` property.

Add an import for the Niche type from `@/types/niche`.

**Change 2: Add niche column to table.**

In the table header (`<thead>`), add a "Niche" column header after "Source" and before "Status":
```html
<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Niche</th>
```

In the table body, add a cell displaying the niche name:
```html
<td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
  {(lead as any).niche?.name || '-'}
</td>
```

Use `(lead as any).niche` because the Lead type doesn't include the join result. This is intentional -- we're not polluting the base Lead type with join-specific fields. The type assertion is contained to just the display cell.

**Change 3: Add niche filter to filter bar.**

Add state: `const [nicheFilter, setNicheFilter] = useState<string>('')`
Add state: `const [niches, setNiches] = useState<Niche[]>([])`

Create a `fetchNiches` callback:
```typescript
const fetchNiches = useCallback(async () => {
  const { data } = await supabase.from('niches').select('*').order('name')
  if (data) setNiches(data)
}, [supabase])
```

Call `fetchNiches()` in the existing useEffect alongside `fetchLeads()` and `fetchCampaigns()`. Add `fetchNiches` to the dependency array.

In `fetchLeads`, add the niche filter condition:
```typescript
if (nicheFilter) {
  query = query.eq('niche_id', nicheFilter)
}
```
Add `nicheFilter` to the `fetchLeads` useCallback dependency array.

Change the filter bar grid from `md:grid-cols-4` to `md:grid-cols-5` to accommodate the new filter.

Add a niche select dropdown BEFORE the Clear Filters button:
```html
<select
  value={nicheFilter}
  onChange={(e) => setNicheFilter(e.target.value)}
  className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
>
  <option value="">All Niches</option>
  {niches.map((niche) => (
    <option key={niche.id} value={niche.id}>{niche.name}</option>
  ))}
</select>
```

Update Clear Filters onClick to also `setNicheFilter('')`.

**Change 4: Add NicheComboBox to Add Lead dialog.**

Add state: `const [selectedNiche, setSelectedNiche] = useState<string | null>(null)`

Import NicheComboBox: `import { NicheComboBox } from '@/components/NicheComboBox'`

In the Add Lead dialog form, add a "Business Niche" field AFTER the "Has a website" checkbox and BEFORE the "Social Media Presence" radio buttons:
```html
<div>
  <label className="block text-sm font-medium text-gray-700 mb-1">Business Niche</label>
  <NicheComboBox value={selectedNiche} onChange={setSelectedNiche} />
</div>
```

In `handleAddLead`, include `niche_id: selectedNiche` in the insert payload.

After successful insert, reset: `setSelectedNiche(null)`.

Also re-fetch niches after adding a lead (in case a new niche was created inline): call `fetchNiches()` alongside `fetchLeads()` in the success handler.

**Things to NOT do:**
- Do NOT change the existing Lead type or create a LeadWithNiche type -- use `(lead as any).niche` for the join result. Keep it simple.
- Do NOT move the NicheComboBox import to a barrel file -- direct import is fine.
- Do NOT add the niche to CSV export yet (out of scope for this phase).
  </action>
  <verify>
1. Run `npm run build` in crm-dashboard -- no errors.
2. Open the leads page in the browser. Verify:
   - "Niche" column header appears between "Source" and "Status"
   - Each row shows "-" for niche (since no leads have niches yet)
   - "All Niches" filter dropdown appears in filter bar
   - Clear Filters clears all 4 filters including niche
3. Open Add Lead dialog. Verify:
   - "Business Niche" field appears with "Select niche..." placeholder
   - Clicking opens a searchable dropdown
   - Typing a name and clicking "Create..." creates a niche
   - After creating, the niche is selected
4. After creating a niche through Add Lead, verify it appears in the Niche filter dropdown too.
  </verify>
  <done>
Leads table shows Niche column with joined niche name. Filter bar has niche dropdown populated from database. Add Lead dialog includes NicheComboBox with inline creation. Clear Filters resets niche. App builds without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate niche into lead detail edit mode</name>
  <files>crm-dashboard/app/(dashboard)/leads/[id]/page.tsx</files>
  <action>
Modify `crm-dashboard/app/(dashboard)/leads/[id]/page.tsx` with these changes:

**Change 1: Add niche_id to editForm state.**

Add `niche_id: null as string | null` to the editForm useState initial value (after `social_media_presence`).

**Change 2: Update fetchLead to include niche join.**

Change the lead query from `select('*')` to `select('*, niche:niches(name)')` so the niche name displays in view mode.

**Change 3: Populate niche_id in startEdit.**

In `startEdit()`, add: `niche_id: lead.niche_id` to the editForm population (uses the niche_id from the Lead type, which was updated in Plan 01).

**Change 4: Add niche_id to changed fields tracking.**

In `saveEdit()`, add to the changedFields calculation:
```typescript
if (editForm.niche_id !== lead.niche_id) changedFields.niche_id = editForm.niche_id
```

**Change 5: Include niche_id in the update payload.**

In `saveEdit()`, add `niche_id: editForm.niche_id` to the `.update({...})` call.

**Change 6: Display niche in view mode.**

In the view mode grid (the `!isEditing` branch), add a field after "Social Media Presence":
```html
<div>
  <label className="block text-sm font-medium text-gray-500">Business Niche</label>
  <span>{(lead as any).niche?.name || '-'}</span>
</div>
```

Use `(lead as any).niche?.name` because the join result isn't in the Lead type (same pattern as leads/page.tsx).

**Change 7: Add NicheComboBox in edit mode.**

Import NicheComboBox: `import { NicheComboBox } from '@/components/NicheComboBox'`

In the edit mode grid (the `isEditing` branch), add after the Social Media Presence radio group:
```html
<div>
  <label className="block text-sm font-medium text-gray-500 mb-1">Business Niche</label>
  <NicheComboBox
    value={editForm.niche_id}
    onChange={(nicheId) => setEditForm({ ...editForm, niche_id: nicheId })}
  />
</div>
```

**Things to NOT do:**
- Do NOT refetch the entire lead after saving just to get niche name -- the existing `fetchLead()` call in the save success handler already does this.
- Do NOT change the fetch for events or orders -- only the leads query needs the niche join.
  </action>
  <verify>
1. Run `npm run build` -- no errors.
2. Navigate to a lead detail page. Verify:
   - "Business Niche" field shows "-" in view mode (no niche assigned yet)
3. Click Edit. Verify:
   - NicheComboBox appears showing "Select niche..."
   - Can search/create niches
   - Selecting a niche and saving updates the lead
4. After saving, verify:
   - View mode now shows the assigned niche name
   - Activity timeline shows a "lead_edited" event with niche_id in the changed fields
  </verify>
  <done>
Lead detail page shows niche in view mode (from join query). Edit mode includes NicheComboBox for niche assignment. Save includes niche_id in update payload and change tracking. Activity timeline logs niche changes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete niche taxonomy integration: database schema (niches, scripts, outcomes tables), NicheComboBox component with inline creation, leads table with niche column and filter, Add Lead dialog with niche field, and lead detail edit mode with niche field.
  </what-built>
  <how-to-verify>
1. Go to the Leads page (Cold Calling client selected)
2. Verify: "Niche" column header visible in table, all leads show "-" (no niches assigned yet)
3. Verify: "All Niches" filter dropdown visible in filter bar (empty options initially)
4. Click "Add Lead" button
5. Verify: "Business Niche" field appears with "Select niche..." button
6. Click the niche selector, type "restaurant", click Create "restaurant"
7. Verify: "restaurant" is now selected (lowercase, not "Restaurant")
8. Fill in at least a name and submit the lead
9. Verify: New lead appears in table with "restaurant" in the Niche column
10. Open the niche filter dropdown -- verify "restaurant" now appears as an option
11. Click on the new lead to go to detail page
12. Verify: "Business Niche" shows "restaurant" in view mode
13. Click Edit, change niche to something new (type "landscaping", create it)
14. Save -- verify "landscaping" shows in view mode and activity log shows the change
15. Go back to leads list, filter by "restaurant" -- verify only restaurant-niche leads show
16. Clear Filters -- verify all leads show again
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. NicheComboBox component exists and renders a searchable dropdown with inline creation
2. Leads table has Niche column showing joined niche name
3. Filter bar has niche dropdown that filters leads by niche_id
4. Add Lead dialog includes niche selection via NicheComboBox
5. Lead detail view mode shows niche name
6. Lead detail edit mode uses NicheComboBox with save/change tracking
7. Niche names are always lowercase (enforced by database CHECK + client normalization)
8. Creating duplicate niches (case-insensitive) is handled gracefully (23505 error caught)
9. `npm run build` passes
</verification>

<success_criteria>
- NicheComboBox renders and allows search, selection, and inline creation
- Leads table displays niche name column with data from join query
- Niche filter dropdown works and clears properly
- Add Lead includes niche_id in insert payload
- Lead detail edit mode saves niche_id changes with audit logging
- All niche names stored lowercase in database
- App builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-schema-niche-taxonomy/14-02-SUMMARY.md`
</output>
