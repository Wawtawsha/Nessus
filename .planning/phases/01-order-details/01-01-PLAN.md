---
phase: 01-order-details
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/app/(dashboard)/orders/page.tsx
  - crm-dashboard/components/OrderDetailModal.tsx
autonomous: false

must_haves:
  truths:
    - "User can click any order row to open a detail view"
    - "Detail view shows all line items with modifiers visible as nested children"
    - "Detail view shows payment breakdown with method, card type, and tip"
  artifacts:
    - path: "crm-dashboard/components/OrderDetailModal.tsx"
      provides: "Modal component displaying order details"
      exports: ["OrderDetailModal"]
      min_lines: 100
    - path: "crm-dashboard/app/(dashboard)/orders/page.tsx"
      provides: "Orders table with clickable rows"
      contains: "onClick"
  key_links:
    - from: "crm-dashboard/app/(dashboard)/orders/page.tsx"
      to: "OrderDetailModal.tsx"
      via: "import and render when selectedOrder is set"
      pattern: "OrderDetailModal.*selectedOrder"
    - from: "OrderDetailModal.tsx"
      to: "toast_order_items"
      via: "supabase select with id field for nesting"
      pattern: "from.*toast_order_items"
    - from: "OrderDetailModal.tsx"
      to: "toast_payments"
      via: "supabase select"
      pattern: "from.*toast_payments"
---

<objective>
Add an order detail modal to the Orders page that displays line items with nested modifiers and payment breakdown.

Purpose: Users need to inspect order details without navigating away from the orders list. This is the foundation for Phase 2's lead matching UI.
Output: Clickable order rows that open a modal showing line items, modifiers, and payments.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Existing files to modify/reference
@crm-dashboard/app/(dashboard)/orders/page.tsx
@crm-dashboard/supabase/migrations/003_toast_items_payments.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrderDetailModal component with complete nesting logic</name>
  <files>crm-dashboard/components/OrderDetailModal.tsx</files>
  <action>
Create a modal component that displays order details. The component receives:
- `order: ToastOrder` (the selected order)
- `onClose: () => void` (close handler)

On mount, fetch line items and payments for this order:

```typescript
// Line items query - explicitly includes id field needed for modifier nesting
// The id field is used to match parent_item_id for building nested structure
// Field names match database schema exactly (see 003_toast_items_payments.sql)
const { data: items } = await supabase
  .from('toast_order_items')
  .select('id, order_id, parent_item_id, display_name, quantity, unit_price, price, tax, voided, is_modifier, created_at')
  .eq('order_id', order.id)
  .order('created_at')

// Payments query
const { data: payments } = await supabase
  .from('toast_payments')
  .select('*')
  .eq('order_id', order.id)
```

Build nested item structure - handles all edge cases:

```typescript
// Build nested structure - filters root items and matches modifiers by parent_item_id
const rootItems = (items || []).filter(i => !i.parent_item_id)
const modifiers = (items || []).filter(i => i.parent_item_id)

// For each root item, find its modifiers using the id field
const nestedItems = rootItems.map(item => ({
  ...item,
  modifiers: modifiers.filter(m => m.parent_item_id === item.id)
}))
```

Edge cases to handle in the component:
1. Order with no modifiers (only root items) - modifiers array will be empty
2. Order with modifiers (items have parent_item_id set) - modifiers nested under parent
3. Order with multiple payment methods - iterate payments array
4. Voided items - show with strikethrough styling (`line-through text-gray-400`)
5. Empty items array - show "No items" message

Modal layout:
1. Header: Order number, date, status (voided badge if applicable)
2. Customer section: Name, email, phone (if available)
3. Line Items section:
   - List root items with display_name, quantity, price
   - Under each root item, indent modifiers (where parent_item_id matches item.id OR is_modifier is true)
   - Apply voided styling to voided items
   - Show item total
4. Payment section:
   - CASH: Just "Cash" and amount
   - CREDIT: "Credit (Visa)" or similar, with last_four if available
   - Other types: payment_type capitalized
   - Show tip for each payment
   - Show total
5. Footer: Close button

Use Tailwind classes consistent with existing pages:
- Modal overlay: fixed inset-0 bg-black/50 flex items-center justify-center z-50
- Modal container: bg-white rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto
- Sections: border-b border-gray-200 p-4
- Headings: text-lg font-semibold text-gray-900
- Modifiers indent: ml-6 text-sm text-gray-600
- Voided items: line-through text-gray-400

Handle loading state while fetching items/payments. Handle empty states gracefully.
  </action>
  <verify>
Run `npm run build` in crm-dashboard - should compile without errors.
Run `npm run lint` - should pass without errors.
Manually inspect component structure matches specification.
  </verify>
  <done>
OrderDetailModal.tsx exists, exports OrderDetailModal component, fetches items with correct schema fields (display_name, price, is_modifier), builds nested modifier structure, handles voided items, renders payment details with card info.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire modal into Orders page</name>
  <files>crm-dashboard/app/(dashboard)/orders/page.tsx</files>
  <action>
Add state for selected order:
```typescript
const [selectedOrder, setSelectedOrder] = useState<ToastOrder | null>(null)
```

Make table rows clickable - add onClick to the `<tr>`:
```typescript
<tr
  key={order.id}
  onClick={() => setSelectedOrder(order)}
  className={`hover:bg-gray-50 cursor-pointer ${order.voided ? 'opacity-50' : ''}`}
>
```

Import and render the modal at end of component:
```typescript
import { OrderDetailModal } from '@/components/OrderDetailModal'

// ... at end of JSX, before closing div
{selectedOrder && (
  <OrderDetailModal
    order={selectedOrder}
    onClose={() => setSelectedOrder(null)}
  />
)}
```

The modal should close when:
- User clicks close button
- User clicks outside modal (optional - implement with overlay click)
- User presses Escape (optional enhancement)
  </action>
  <verify>
Prerequisites: Ensure test database has orders with line items and payments. Run Toast sync first if needed (`npm run sync:toast` or equivalent).

Run `npm run dev` in crm-dashboard.
Navigate to /orders page.
Click any order row - modal should appear.
Modal should show line items and payments.
Close button should dismiss modal.
  </verify>
  <done>
Clicking order row opens modal, modal displays items and payments, modal can be closed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify modal handles all order variations</name>
  <what-built>
Order detail modal with:
- Line items with nested modifiers
- Payment breakdown with card info
- Voided item/order styling
  </what-built>
  <how-to-verify>
Test the modal with different order types:

1. Find an order with multiple line items (no modifiers):
   - Open modal, verify all items display with name, quantity, price
   - Verify items are NOT indented (they're root items)

2. Find an order with modifiers (e.g., pizza with toppings, drink with size):
   - Open modal, verify modifiers appear indented under parent item
   - Verify modifier shows name and price adjustment

3. Find an order with multiple payment methods (split tender):
   - Open modal, verify each payment shows separately
   - Verify CREDIT payments show card type (Visa/MC/etc) and last four

4. Find a voided order or order with voided items:
   - Open modal, verify voided items show strikethrough styling
   - Verify voided order shows status badge in header

5. Test modal behavior:
   - Click close button - modal should dismiss
   - Click overlay (outside modal) - should dismiss (if implemented)
   - Press Escape - should dismiss (if implemented)
  </how-to-verify>
  <resume-signal>Type "approved" if all scenarios work correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Orders page loads at /orders
3. Clicking any order row opens modal
4. Modal shows order header with date and number
5. Modal shows customer info if present
6. Modal shows line items with nested modifiers indented
7. Modal shows payment breakdown with method and card info
8. Close button dismisses modal
9. Page remains usable after closing modal
</verification>

<success_criteria>
- ORD-01: Order rows are clickable and open detail modal
- ORD-02: Line items display with modifiers nested under parent items
- ORD-03: Payments show method, card type (for credit), and tip amount
</success_criteria>

<output>
After completion, create `.planning/phases/01-order-details/01-01-SUMMARY.md`
</output>
