---
phase: 01-order-details
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/app/(dashboard)/orders/page.tsx
  - crm-dashboard/components/OrderDetailModal.tsx
autonomous: true

must_haves:
  truths:
    - "User can click any order row to open a detail view"
    - "Detail view shows all line items with modifiers visible as nested children"
    - "Detail view shows payment breakdown with method, card type, and tip"
  artifacts:
    - path: "crm-dashboard/components/OrderDetailModal.tsx"
      provides: "Modal component displaying order details"
      exports: ["OrderDetailModal"]
      min_lines: 100
    - path: "crm-dashboard/app/(dashboard)/orders/page.tsx"
      provides: "Orders table with clickable rows"
      contains: "onClick"
  key_links:
    - from: "crm-dashboard/app/(dashboard)/orders/page.tsx"
      to: "OrderDetailModal.tsx"
      via: "import and render when selectedOrder is set"
      pattern: "OrderDetailModal.*selectedOrder"
    - from: "OrderDetailModal.tsx"
      to: "toast_order_items"
      via: "supabase select"
      pattern: "from.*toast_order_items"
    - from: "OrderDetailModal.tsx"
      to: "toast_payments"
      via: "supabase select"
      pattern: "from.*toast_payments"
---

<objective>
Add an order detail modal to the Orders page that displays line items with nested modifiers and payment breakdown.

Purpose: Users need to inspect order details without navigating away from the orders list. This is the foundation for Phase 2's lead matching UI.
Output: Clickable order rows that open a modal showing line items, modifiers, and payments.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Existing files to modify/reference
@crm-dashboard/app/(dashboard)/orders/page.tsx
@crm-dashboard/supabase/migrations/003_toast_items_payments.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrderDetailModal component</name>
  <files>crm-dashboard/components/OrderDetailModal.tsx</files>
  <action>
Create a modal component that displays order details. The component receives:
- `order: ToastOrder` (the selected order)
- `onClose: () => void` (close handler)

On mount, fetch line items and payments for this order:

```typescript
// Line items query - gets items with parent_item_id for modifier nesting
const { data: items } = await supabase
  .from('toast_order_items')
  .select('*')
  .eq('order_id', order.id)
  .order('created_at')

// Payments query
const { data: payments } = await supabase
  .from('toast_payments')
  .select('*')
  .eq('order_id', order.id)
```

Build nested item structure by filtering root items (parent_item_id is null) and finding their children.

Modal layout:
1. Header: Order number, date, status (voided badge if applicable)
2. Customer section: Name, email, phone (if available)
3. Line Items section:
   - List root items with name, quantity, price
   - Under each root item, indent modifiers (where parent_item_id matches)
   - Show item total
4. Payment section:
   - For each payment: type, card_type (if CREDIT), last_four (if available), amount, tip
   - Show total
5. Footer: Close button

Use Tailwind classes consistent with existing pages:
- Modal overlay: fixed inset-0 bg-black/50 flex items-center justify-center z-50
- Modal container: bg-white rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto
- Sections: border-b border-gray-200 p-4
- Headings: text-lg font-semibold text-gray-900

Handle loading state while fetching items/payments. Handle empty states.
  </action>
  <verify>
Run `npm run build` in crm-dashboard - should compile without errors.
Manually inspect component structure matches specification.
  </verify>
  <done>
OrderDetailModal.tsx exists, exports OrderDetailModal component, fetches items and payments, renders nested modifiers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire modal into Orders page</name>
  <files>crm-dashboard/app/(dashboard)/orders/page.tsx</files>
  <action>
Add state for selected order:
```typescript
const [selectedOrder, setSelectedOrder] = useState<ToastOrder | null>(null)
```

Make table rows clickable - add onClick to the `<tr>`:
```typescript
<tr
  key={order.id}
  onClick={() => setSelectedOrder(order)}
  className={`hover:bg-gray-50 cursor-pointer ${order.voided ? 'opacity-50' : ''}`}
>
```

Import and render the modal at end of component:
```typescript
import { OrderDetailModal } from '@/components/OrderDetailModal'

// ... at end of JSX, before closing div
{selectedOrder && (
  <OrderDetailModal
    order={selectedOrder}
    onClose={() => setSelectedOrder(null)}
  />
)}
```

The modal should close when:
- User clicks close button
- User clicks outside modal (optional - implement with overlay click)
- User presses Escape (optional enhancement)
  </action>
  <verify>
Run `npm run dev` in crm-dashboard.
Navigate to /orders page.
Click any order row - modal should appear.
Modal should show line items and payments.
Close button should dismiss modal.
  </verify>
  <done>
Clicking order row opens modal, modal displays items and payments, modal can be closed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test modifier nesting and payment display</name>
  <files>crm-dashboard/components/OrderDetailModal.tsx</files>
  <action>
Verify the modifier nesting logic handles these cases:
1. Order with no modifiers (only root items)
2. Order with modifiers (items have parent_item_id set)
3. Order with multiple payment methods
4. Order with voided items (show with strikethrough or badge)

If testing reveals issues, fix the nesting logic:
```typescript
// Build nested structure
const rootItems = items.filter(i => !i.parent_item_id)
const modifiers = items.filter(i => i.parent_item_id)

// For each root item, find its modifiers
rootItems.map(item => ({
  ...item,
  modifiers: modifiers.filter(m => m.parent_item_id === item.id)
}))
```

Ensure voided items are visually distinct (add `line-through text-gray-400` styling).
Ensure voided orders show clear status in header.

For payments, show:
- CASH: Just "Cash" and amount
- CREDIT: "Credit (Visa)" or similar, with last_four if available
- Other types: payment_type capitalized
  </action>
  <verify>
Test with orders that have:
- Multiple line items
- Items with modifiers
- Multiple payment methods
- Voided items

All scenarios should render correctly without errors.
  </verify>
  <done>
Modifier nesting works for multi-level items, payments display with card info, voided states are visible.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Orders page loads at /orders
3. Clicking any order row opens modal
4. Modal shows order header with date and number
5. Modal shows customer info if present
6. Modal shows line items with nested modifiers indented
7. Modal shows payment breakdown with method and card info
8. Close button dismisses modal
9. Page remains usable after closing modal
</verification>

<success_criteria>
- ORD-01: Order rows are clickable and open detail modal
- ORD-02: Line items display with modifiers nested under parent items
- ORD-03: Payments show method, card type (for credit), and tip amount
</success_criteria>

<output>
After completion, create `.planning/phases/01-order-details/01-01-SUMMARY.md`
</output>
