---
phase: 16-outcome-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/supabase/migrations/08_script_outcome_stats.sql
  - crm-dashboard/types/script.ts
  - crm-dashboard/lib/schemas/outcomeSchema.ts
autonomous: true

must_haves:
  truths:
    - "RPC function get_script_outcome_stats returns success_count, fail_count, total_count, win_rate per script for a given client"
    - "Scripts with zero outcomes return 0 counts and 0 win_rate (LEFT JOIN behavior)"
    - "TypeScript types exist for ScriptWithStats and ScriptOutcome"
    - "Zod schema validates outcome form (lead_id required UUID, notes optional)"
  artifacts:
    - path: "crm-dashboard/supabase/migrations/08_script_outcome_stats.sql"
      provides: "PostgreSQL RPC for aggregated outcome counters"
      contains: "get_script_outcome_stats"
    - path: "crm-dashboard/types/script.ts"
      provides: "ScriptWithStats and ScriptOutcome interfaces"
      exports: ["Script", "ScriptWithStats", "ScriptOutcome", "OutcomeStats"]
    - path: "crm-dashboard/lib/schemas/outcomeSchema.ts"
      provides: "Zod schema for outcome form validation"
      exports: ["outcomeSchema", "OutcomeFormValues"]
  key_links:
    - from: "crm-dashboard/types/script.ts"
      to: "crm-dashboard/supabase/migrations/08_script_outcome_stats.sql"
      via: "OutcomeStats type matches RPC return columns"
      pattern: "success_count.*fail_count.*total_count.*win_rate"
---

<objective>
Create the database RPC function for aggregated script outcome stats and the TypeScript types/schemas needed by the outcome tracking UI.

Purpose: Provides the data layer (RPC aggregation) and type safety (interfaces + Zod schema) that Plan 02 will consume for the RecordOutcomeDialog and ScriptCard stats display.

Output: One SQL migration file, extended Script types, and a Zod outcome schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-outcome-tracking/16-RESEARCH.md
@.planning/phases/15-script-library-crud/15-01-SUMMARY.md

# Key source files
@crm-dashboard/supabase/migrations/07_scripts_niches_outcomes.sql
@crm-dashboard/supabase/migrations/005_revenue_exclude_invoices.sql
@crm-dashboard/types/script.ts
@crm-dashboard/types/lead.ts
@crm-dashboard/lib/schemas/scriptSchema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RPC migration for script outcome stats</name>
  <files>crm-dashboard/supabase/migrations/08_script_outcome_stats.sql</files>
  <action>
Create a PostgreSQL RPC function `get_script_outcome_stats` that aggregates outcome counts per script for a given client.

Follow the exact pattern from `get_revenue_by_period` (migration 005): `CREATE OR REPLACE FUNCTION`, `RETURNS TABLE`, `LANGUAGE plpgsql SECURITY DEFINER`.

Function signature:
- Input: `p_client_id UUID`
- Returns TABLE: `script_id UUID`, `success_count BIGINT`, `fail_count BIGINT`, `total_count BIGINT`, `win_rate NUMERIC`

Query logic:
- SELECT from `scripts s` LEFT JOIN `script_lead_outcomes o` ON `o.script_id = s.id`
- WHERE `s.client_id = p_client_id` AND `s.is_active = true`
- GROUP BY `s.id`
- Use `COUNT(*) FILTER (WHERE o.outcome = 'success')` for success_count (wrap in COALESCE to 0)
- Use `COUNT(*) FILTER (WHERE o.outcome = 'fail')` for fail_count (wrap in COALESCE to 0)
- For total_count: `COUNT(o.id)` not `COUNT(*)` -- COUNT(*) counts the script row itself even with no outcomes. COUNT(o.id) correctly returns 0 when LEFT JOIN produces NULL.
- For win_rate: CASE WHEN `COUNT(o.id) > 0` THEN `ROUND((COUNT(*) FILTER (WHERE o.outcome = 'success')::NUMERIC / COUNT(o.id)::NUMERIC) * 100, 1)` ELSE `0` END
- Add COMMENT ON FUNCTION explaining purpose

CRITICAL: Must use LEFT JOIN so scripts with zero outcomes still appear with 0 counts. Using INNER JOIN would hide scripts with no outcomes.

CRITICAL: Use COUNT(o.id) instead of COUNT(*) for total_count. With LEFT JOIN, COUNT(*) returns 1 even when there are no matching outcomes (because the left side row still counts). COUNT(o.id) returns 0 when o.id is NULL.
  </action>
  <verify>
Read the migration file and verify:
1. LEFT JOIN is used (not INNER JOIN)
2. COUNT(o.id) is used for total_count (not COUNT(*))
3. COALESCE wraps all count expressions
4. SECURITY DEFINER is specified
5. Division by zero handled in win_rate CASE expression
6. COMMENT ON FUNCTION exists
  </verify>
  <done>Migration file exists with correct LEFT JOIN, COUNT(o.id), COALESCE, SECURITY DEFINER, division-by-zero guard, and documentation comment.</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript types and Zod outcome schema</name>
  <files>crm-dashboard/types/script.ts, crm-dashboard/lib/schemas/outcomeSchema.ts</files>
  <action>
**In `crm-dashboard/types/script.ts`:**

Keep the existing `Script` interface unchanged. Add three new exports below it:

1. `OutcomeStats` interface matching the RPC return columns:
   - `script_id: string`
   - `success_count: number`
   - `fail_count: number`
   - `total_count: number`
   - `win_rate: number`

2. `ScriptWithStats` interface:
   - Extends `Script` with `stats: OutcomeStats`
   - Use intersection: `Script & { stats: OutcomeStats }`
   - Export as a type alias, not interface (simpler)

3. `ScriptOutcome` interface matching the `script_lead_outcomes` table:
   - `id: string`
   - `script_id: string`
   - `lead_id: string`
   - `outcome: 'success' | 'fail'`
   - `notes: string | null`
   - `created_at: string`
   - `created_by: string | null`

**In `crm-dashboard/lib/schemas/outcomeSchema.ts`:**

Create a Zod schema for the outcome recording form. Follow the pattern from `scriptSchema.ts`.

Schema fields:
- `lead_id`: `z.string().uuid('Please select a lead')` -- required, must be valid UUID
- `notes`: `z.string().optional()` -- optional text

Export the schema as `outcomeSchema` and the inferred type as `OutcomeFormValues`.
  </action>
  <verify>
1. `npx tsc --noEmit` from crm-dashboard directory (or check that existing build still passes)
2. Read both files and verify exports match the specification
3. Confirm Script interface is unchanged (no breaking changes)
  </verify>
  <done>
- `crm-dashboard/types/script.ts` exports Script (unchanged), OutcomeStats, ScriptWithStats, ScriptOutcome
- `crm-dashboard/lib/schemas/outcomeSchema.ts` exports outcomeSchema and OutcomeFormValues
- No breaking changes to existing Script type consumers
  </done>
</task>

</tasks>

<verification>
1. Migration file uses LEFT JOIN (grep for "LEFT JOIN")
2. Migration file uses COUNT(o.id) for total_count (not COUNT(*))
3. Migration file has SECURITY DEFINER
4. Script types file has 4 exports: Script, OutcomeStats, ScriptWithStats, ScriptOutcome
5. Outcome schema validates lead_id as required UUID and notes as optional
6. Build passes: `cd crm-dashboard && npx next build` (or `npx tsc --noEmit`)
</verification>

<success_criteria>
- RPC function `get_script_outcome_stats` handles zero-outcome scripts correctly (LEFT JOIN + COUNT(o.id))
- TypeScript types match database schema exactly
- Zod schema enforces lead_id required + notes optional
- No breaking changes to existing Script type consumers
</success_criteria>

<output>
After completion, create `.planning/phases/16-outcome-tracking/16-01-SUMMARY.md`
</output>
