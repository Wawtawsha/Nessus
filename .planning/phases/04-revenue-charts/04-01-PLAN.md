---
phase: 04-revenue-charts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/package.json
  - crm-dashboard/components/ui/chart.tsx
  - crm-dashboard/components/ui/calendar.tsx
  - crm-dashboard/components/ui/popover.tsx
  - crm-dashboard/components/ui/button.tsx
  - crm-dashboard/lib/utils.ts
  - crm-dashboard/supabase/migrations/004_revenue_aggregation.sql
  - crm-dashboard/app/(dashboard)/analytics/components/RevenueChart.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/ChartControls.tsx
  - crm-dashboard/app/(dashboard)/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Analytics page displays a time-series revenue chart"
    - "User can toggle between daily, weekly, and monthly granularity"
    - "User can select a custom date range for the chart"
    - "Chart shows empty state when no data exists for selected period"
  artifacts:
    - path: "crm-dashboard/components/ui/chart.tsx"
      provides: "shadcn/ui Chart wrapper for Recharts"
      contains: "ChartContainer"
    - path: "crm-dashboard/supabase/migrations/004_revenue_aggregation.sql"
      provides: "PostgreSQL RPC for time-series aggregation"
      contains: "get_revenue_by_period"
    - path: "crm-dashboard/app/(dashboard)/analytics/components/RevenueChart.tsx"
      provides: "Client component rendering Recharts LineChart"
      contains: "use client"
    - path: "crm-dashboard/app/(dashboard)/analytics/components/ChartControls.tsx"
      provides: "Granularity toggle and date range picker"
      contains: "DateRangePicker"
  key_links:
    - from: "crm-dashboard/app/(dashboard)/analytics/page.tsx"
      to: "supabase.rpc('get_revenue_by_period')"
      via: "fetchRevenueData callback"
      pattern: "rpc.*get_revenue_by_period"
    - from: "crm-dashboard/app/(dashboard)/analytics/components/RevenueChart.tsx"
      to: "recharts"
      via: "LineChart import"
      pattern: "from 'recharts'"
---

<objective>
Add time-series revenue visualization to the Analytics page with granularity controls (daily/weekly/monthly) and custom date range selection.

Purpose: Enable users to visualize revenue trends over time, fulfilling CHART-01, CHART-02, and CHART-03 requirements for milestone v1.1.

Output: A working revenue chart section on the Analytics page with interactive controls for granularity and date range.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-revenue-charts/04-RESEARCH.md

# Existing analytics page structure
@crm-dashboard/app/(dashboard)/analytics/page.tsx

# Package dependencies
@crm-dashboard/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui chart dependencies and create components</name>
  <files>
    crm-dashboard/package.json
    crm-dashboard/components/ui/chart.tsx
    crm-dashboard/components/ui/calendar.tsx
    crm-dashboard/components/ui/popover.tsx
    crm-dashboard/components/ui/button.tsx
    crm-dashboard/lib/utils.ts
    crm-dashboard/components.json
    crm-dashboard/tailwind.config.ts
  </files>
  <action>
    Install shadcn/ui and required chart components:

    1. Initialize shadcn/ui if not already done:
       ```bash
       cd crm-dashboard
       npx shadcn@latest init
       ```
       - Style: Default
       - Base color: Slate
       - CSS variables: Yes

    2. Add chart component (includes Recharts):
       ```bash
       npx shadcn@latest add chart
       ```

    3. Add date picker dependencies:
       ```bash
       npx shadcn@latest add calendar popover button
       npm install date-fns
       ```

    The shadcn CLI will create:
    - components/ui/chart.tsx (ChartContainer, ChartTooltip, etc.)
    - components/ui/calendar.tsx (Calendar component)
    - components/ui/popover.tsx (Popover for date picker)
    - components/ui/button.tsx (Button component)
    - lib/utils.ts (cn utility if not exists)
    - components.json (shadcn config)

    Note: If init prompts conflict with existing tailwind.config.ts, choose to keep existing and manually merge CSS variables.
  </action>
  <verify>
    - `ls crm-dashboard/components/ui/` shows chart.tsx, calendar.tsx, popover.tsx, button.tsx
    - `grep -q "recharts" crm-dashboard/package.json` returns 0
    - `grep -q "date-fns" crm-dashboard/package.json` returns 0
    - `npm run build` in crm-dashboard succeeds (no TypeScript errors)
  </verify>
  <done>
    shadcn/ui installed with chart, calendar, popover, and button components. Recharts and date-fns added to package.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PostgreSQL RPC for revenue aggregation</name>
  <files>
    crm-dashboard/supabase/migrations/004_revenue_aggregation.sql
  </files>
  <action>
    Create a PostgreSQL function that aggregates revenue by time period. The function must:

    1. Accept parameters:
       - p_granularity: TEXT ('day', 'week', 'month')
       - p_start_date: DATE
       - p_end_date: DATE
       - p_client_id: UUID (optional, for multi-tenant filtering)

    2. Return columns:
       - period: TEXT (ISO date string for chart x-axis)
       - revenue: NUMERIC (sum of total_amount)
       - order_count: BIGINT (count of orders)

    3. Use date_trunc() on business_date converted from integer YYYYMMDD to date:
       ```sql
       -- Convert business_date integer (20260122) to date
       to_date(business_date::text, 'YYYYMMDD')
       ```

    4. Group by truncated period and order ascending.

    5. Handle client filtering: if p_client_id is NULL, return all; otherwise filter.

    6. Add SECURITY DEFINER to allow RLS-respecting access through RPC.

    Example SQL structure:
    ```sql
    CREATE OR REPLACE FUNCTION get_revenue_by_period(
      p_granularity TEXT,
      p_start_date DATE,
      p_end_date DATE,
      p_client_id UUID DEFAULT NULL
    )
    RETURNS TABLE (
      period TEXT,
      revenue NUMERIC,
      order_count BIGINT
    ) AS $$
    BEGIN
      RETURN QUERY
      SELECT
        date_trunc(p_granularity, to_date(business_date::text, 'YYYYMMDD'))::date::text as period,
        COALESCE(SUM(total_amount), 0)::NUMERIC as revenue,
        COUNT(*)::BIGINT as order_count
      FROM toast_orders
      WHERE to_date(business_date::text, 'YYYYMMDD') >= p_start_date
        AND to_date(business_date::text, 'YYYYMMDD') <= p_end_date
        AND (p_client_id IS NULL OR client_id = p_client_id)
        AND voided = false
      GROUP BY date_trunc(p_granularity, to_date(business_date::text, 'YYYYMMDD'))
      ORDER BY period ASC;
    END;
    $$ LANGUAGE plpgsql SECURITY DEFINER;
    ```

    Note: Exclude voided orders from revenue calculations.
  </action>
  <verify>
    - File exists at crm-dashboard/supabase/migrations/004_revenue_aggregation.sql
    - SQL is syntactically valid (no obvious errors)
    - Function name is get_revenue_by_period
    - Parameters match: p_granularity, p_start_date, p_end_date, p_client_id
    - Returns period, revenue, order_count

    After deployment to Supabase (manual step):
    - Test with: `SELECT * FROM get_revenue_by_period('day', '2026-01-01', '2026-01-31', NULL);`
  </verify>
  <done>
    Migration file created with get_revenue_by_period RPC function that aggregates toast_orders by day/week/month.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create RevenueChart and ChartControls components</name>
  <files>
    crm-dashboard/app/(dashboard)/analytics/components/RevenueChart.tsx
    crm-dashboard/app/(dashboard)/analytics/components/ChartControls.tsx
  </files>
  <action>
    Create two client components for the revenue chart section:

    **RevenueChart.tsx:**
    - 'use client' directive (required for Recharts)
    - Props: data: { period: string; revenue: number; order_count: number }[]
    - Use shadcn/ui ChartContainer with min-h-[300px] w-full
    - Render Recharts LineChart with:
      - XAxis: dataKey="period", format dates with date-fns (MMM d for daily, week of MMM d for weekly, MMM yyyy for monthly)
      - YAxis: format as currency ($X,XXX)
      - ChartTooltip showing revenue and order count
      - Line: type="monotone", dataKey="revenue", no dots for cleaner look
      - CartesianGrid with strokeDasharray="3 3"
    - Empty state: Show message "No revenue data for selected period" with dashed border
    - Import format, parseISO from date-fns

    **ChartControls.tsx:**
    - 'use client' directive
    - Props:
      - granularity: 'day' | 'week' | 'month'
      - onGranularityChange: (g: 'day' | 'week' | 'month') => void
      - dateRange: { from: Date; to: Date }
      - onDateRangeChange: (range: { from: Date; to: Date }) => void
    - Granularity toggle: Three buttons (Daily, Weekly, Monthly) using shadcn Button
      - Active button: variant="default"
      - Inactive: variant="outline"
    - Date range picker: shadcn Popover + Calendar with mode="range"
      - Show "MMM d, yyyy - MMM d, yyyy" format on trigger button
      - numberOfMonths={2} for better UX
      - CalendarIcon from lucide-react
    - Layout: flex justify-between with granularity on left, date picker on right
  </action>
  <verify>
    - Both files exist in crm-dashboard/app/(dashboard)/analytics/components/
    - Both have 'use client' directive
    - RevenueChart imports from recharts and @/components/ui/chart
    - ChartControls imports from @/components/ui/calendar, popover, button
    - No TypeScript errors: `npx tsc --noEmit` in crm-dashboard
  </verify>
  <done>
    RevenueChart and ChartControls client components created with proper shadcn/ui and Recharts integration.
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate chart section into Analytics page</name>
  <files>
    crm-dashboard/app/(dashboard)/analytics/page.tsx
  </files>
  <action>
    Modify the existing Analytics page to add the revenue chart section:

    1. Add imports at top:
       ```typescript
       import { RevenueChart } from './components/RevenueChart'
       import { ChartControls } from './components/ChartControls'
       ```

    2. Add state for chart:
       ```typescript
       const [granularity, setGranularity] = useState<'day' | 'week' | 'month'>('day')
       const [dateRange, setDateRange] = useState({
         from: new Date(new Date().setDate(new Date().getDate() - 30)),
         to: new Date()
       })
       const [revenueChartData, setRevenueChartData] = useState<{period: string; revenue: number; order_count: number}[]>([])
       ```

    3. Add fetchRevenueChartData function inside the component:
       ```typescript
       const fetchRevenueChartData = useCallback(async () => {
         const clientIdParam = isAdmin && currentClientId ? currentClientId : null

         const { data, error } = await supabase.rpc('get_revenue_by_period', {
           p_granularity: granularity,
           p_start_date: dateRange.from.toISOString().split('T')[0],
           p_end_date: dateRange.to.toISOString().split('T')[0],
           p_client_id: clientIdParam
         })

         if (!error && data) {
           setRevenueChartData(data)
         }
       }, [supabase, granularity, dateRange, isAdmin, currentClientId])
       ```

    4. Add useEffect to call fetchRevenueChartData when dependencies change:
       ```typescript
       useEffect(() => {
         fetchRevenueChartData()
       }, [fetchRevenueChartData])
       ```

    5. Add chart section JSX after Revenue Overview stats (before Lead Overview):
       ```tsx
       {/* Revenue Over Time Chart */}
       <div className="mb-8">
         <div className="flex justify-between items-center mb-4">
           <h2 className="text-lg font-semibold text-gray-900">Revenue Over Time</h2>
         </div>
         <div className="bg-white rounded-lg shadow p-6">
           <ChartControls
             granularity={granularity}
             onGranularityChange={setGranularity}
             dateRange={dateRange}
             onDateRangeChange={setDateRange}
           />
           <div className="mt-4">
             <RevenueChart data={revenueChartData} />
           </div>
         </div>
       </div>
       ```

    Note: The existing fetchStats function polls every 30 seconds. The chart will also refresh via useEffect when dependencies change, but does NOT need separate polling (revenue data changes less frequently).
  </action>
  <verify>
    - `npm run build` succeeds
    - `npm run dev` starts without errors
    - Visit /analytics in browser:
      - Revenue Over Time section visible below Revenue Overview
      - ChartControls shows Daily/Weekly/Monthly buttons and date picker
      - RevenueChart renders (may show empty state if no data)
      - Changing granularity updates chart
      - Changing date range updates chart
  </verify>
  <done>
    Analytics page updated with RevenueChart and ChartControls. Chart fetches data via get_revenue_by_period RPC and responds to control changes.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **CHART-01 (Time-series chart):**
   - Navigate to /analytics
   - Confirm "Revenue Over Time" section exists with a line chart
   - Chart shows data points connected by lines (or empty state if no data)

2. **CHART-02 (Granularity toggle):**
   - Click "Daily" - chart shows daily data points
   - Click "Weekly" - chart aggregates to weekly
   - Click "Monthly" - chart aggregates to monthly
   - Active button is visually distinct (filled vs outline)

3. **CHART-03 (Custom date range):**
   - Click date range button
   - Popover shows two-month calendar
   - Select a date range
   - Chart updates to show only data within selected range
   - Button text updates to show selected range

4. **Edge cases:**
   - Select a date range with no orders - empty state message appears
   - Toggle granularity with no data - empty state persists
   - Admin: Select different client - chart updates for that client
</verification>

<success_criteria>
- [ ] shadcn/ui chart, calendar, popover, button components installed
- [ ] Recharts and date-fns in package.json dependencies
- [ ] get_revenue_by_period PostgreSQL RPC function created
- [ ] RevenueChart component renders line chart with proper formatting
- [ ] ChartControls component provides granularity toggle and date picker
- [ ] Analytics page shows revenue chart section
- [ ] Granularity changes trigger data refetch and chart update
- [ ] Date range changes trigger data refetch and chart update
- [ ] Empty state displays when no data for selection
- [ ] Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-revenue-charts/04-01-SUMMARY.md`
</output>
