---
phase: 11-referrer-analysis-geo-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/app/(dashboard)/analytics/components/shared/types.ts
  - crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/ReferrerAnalysis.tsx
  - crm-dashboard/app/(dashboard)/analytics/components/sections/GeoDistribution.tsx
autonomous: true

must_haves:
  truths:
    - "Deep Dive tab shows referrer breakdown categorized by source type (direct, social, self-referral)"
    - "Deep Dive tab shows geographic distribution of visitors by city and country"
    - "Referrer analysis shows engagement quality per source (avg events/session for visitors from each referrer)"
    - "Geo section shows top cities ranked by visit count with visual bars"
    - "Site filter (All Sites / Press Club / Rosemont) applies to both new sections"
  artifacts:
    - path: "crm-dashboard/app/(dashboard)/analytics/components/shared/types.ts"
      provides: "Extended Visit interface with referrer and geo fields"
      contains: "referrer"
    - path: "crm-dashboard/app/(dashboard)/analytics/components/sections/ReferrerAnalysis.tsx"
      provides: "Referrer source categorization and engagement quality"
      exports: ["ReferrerAnalysis"]
    - path: "crm-dashboard/app/(dashboard)/analytics/components/sections/GeoDistribution.tsx"
      provides: "City and country visitor distribution"
      exports: ["GeoDistribution"]
  key_links:
    - from: "crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx"
      to: "supabase visits table"
      via: "select query includes referrer, country, city, region, latitude, longitude"
      pattern: "referrer.*country.*city"
    - from: "crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx"
      to: "ReferrerAnalysis and GeoDistribution"
      via: "JSX render in Deep Dive tab"
      pattern: "<ReferrerAnalysis|<GeoDistribution"
    - from: "crm-dashboard/app/(dashboard)/analytics/components/sections/ReferrerAnalysis.tsx"
      to: "shared/types.ts"
      via: "Visit interface import"
      pattern: "import.*Visit.*from.*shared/types"
---

<objective>
Add Referrer Analysis and Geographic Distribution sections to the Deep Dive tab in ShrikeAnalytics.

Purpose: Surface which external sources (Facebook, Instagram, direct) drive visitors and where visitors are located geographically. This uses existing visit data columns (referrer, country, city) that are already in the database but not yet queried or displayed.

Output: Two new autonomous section components in the Deep Dive tab, following the established section component pattern from Phase 9.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (architecture decisions)
@.planning/phases/09-component-decomposition/09-01-SUMMARY.md
@.planning/phases/10-session-journeys-time-on-page/10-01-SUMMARY.md

# Current source files
@crm-dashboard/app/(dashboard)/analytics/components/shared/types.ts
@crm-dashboard/app/(dashboard)/analytics/components/shared/constants.ts
@crm-dashboard/app/(dashboard)/analytics/components/shared/StatCard.tsx
@crm-dashboard/app/(dashboard)/analytics/components/shared/BreakdownCard.tsx
@crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx
@crm-dashboard/app/(dashboard)/analytics/components/sections/SessionJourneys.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Visit interface and Supabase query with referrer + geo fields</name>
  <files>
    crm-dashboard/app/(dashboard)/analytics/components/shared/types.ts
    crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx
  </files>
  <action>
    1. In shared/types.ts, add these fields to the Visit interface:
       - referrer: string | null
       - country: string | null
       - city: string | null
       - region: string | null
       - latitude: number | null
       - longitude: number | null

    2. In ShrikeAnalytics.tsx, update the Supabase select string on line 45 from:
       'event_name, event_data, session_id, page_path, created_at, user_agent'
       to:
       'event_name, event_data, session_id, page_path, created_at, user_agent, referrer, country, city, region, latitude, longitude'

    These columns already exist in the visits table (confirmed by database schema). No migration needed.

    IMPORTANT: Do NOT change anything else in ShrikeAnalytics.tsx yet. The section imports and Deep Dive tab wiring happen in Task 3.
  </action>
  <verify>
    Run `npx tsc --noEmit` from crm-dashboard/ to confirm no type errors.
    Existing section components should still compile because they only use existing Visit fields.
  </verify>
  <done>
    Visit interface includes referrer, country, city, region, latitude, longitude.
    Supabase query fetches all 12 columns. No type errors across codebase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ReferrerAnalysis section component</name>
  <files>
    crm-dashboard/app/(dashboard)/analytics/components/sections/ReferrerAnalysis.tsx
  </files>
  <action>
    Create ReferrerAnalysis.tsx following the established section component pattern:
    - Function signature: `export function ReferrerAnalysis({ visits }: { visits: Visit[] })`
    - Import Visit from '../shared/types', StatCard from '../shared/StatCard'
    - All computation via useMemo

    **Referrer categorization logic (in useMemo):**
    Parse each visit's referrer field and categorize into source types:
    - "Direct" — referrer is null or empty
    - "Facebook" — referrer contains 'facebook.com' or 'm.facebook.com' or has 'fbclid' in the URL
    - "Instagram" — referrer contains 'instagram.com' or 'l.instagram.com'
    - "Self-referral" — referrer contains 'shrike.vercel.app' (user navigating within the site)
    - "Other" — anything else (catch-all for unknown referrers)

    Use case-insensitive matching. Extract the category from the raw referrer URL — do NOT use a library, just string matching with .includes() and regex.

    **Stats to compute:**
    - Total visits with referrer data (non-null referrer count)
    - Visits per source category (Direct, Facebook, Instagram, Self-referral, Other)
    - Percentage of total for each category

    **Engagement quality per source (key differentiator):**
    For each referrer category, compute the average number of events per session for visitors arriving from that source:
    1. Group visits by session_id
    2. For each session, determine the referrer category from the FIRST event in the session (the landing page)
    3. Count events per session
    4. Average events/session per source category
    This shows which traffic sources produce the most engaged visitors.

    **Rendering:**
    1. Summary stat row (3 StatCards): "Total Sources" (unique referrer count), "Social Traffic" (Facebook + Instagram %), "Top Source" (category name with highest count)
    2. Source breakdown table: rows for each category sorted by count descending, showing:
       - Category name (with a colored dot — use consistent colors: Direct=#6b7280, Facebook=#1877f2, Instagram=#e4405f, Self-referral=#9ca3af, Other=#d97706)
       - Visit count
       - Percentage bar (similar to BreakdownCard style but inline)
       - Avg events/session for that source (engagement quality indicator)
    3. If zero referrer data, show "No referrer data available" message.

    Wrap the whole component in the standard section container: `<div className="bg-white rounded-lg shadow p-6 mb-8">`
    Section title: "Referrer Analysis"
  </action>
  <verify>
    Run `npx tsc --noEmit` from crm-dashboard/ to confirm the component compiles.
    Visually inspect: component should handle empty referrer data gracefully (the 50% with null referrers go into "Direct" category).
  </verify>
  <done>
    ReferrerAnalysis.tsx exists, exports ReferrerAnalysis component, categorizes referrers into 5 source types, shows engagement quality (avg events/session) per source, handles null referrers as "Direct", and compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create GeoDistribution section component + wire both into Deep Dive tab</name>
  <files>
    crm-dashboard/app/(dashboard)/analytics/components/sections/GeoDistribution.tsx
    crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx
  </files>
  <action>
    **Part A: Create GeoDistribution.tsx**

    Follow the established section component pattern:
    - Function signature: `export function GeoDistribution({ visits }: { visits: Visit[] })`
    - Import Visit from '../shared/types', StatCard from '../shared/StatCard'
    - All computation via useMemo

    **Geo computation logic (in useMemo):**
    1. Filter visits where city is non-null (93.5% of data has geo)
    2. Count visits per city (format as "City, Region" e.g. "Farmville, VA" — use 2-letter state/region abbreviation if region is a US state name, otherwise use full region)
    3. Count visits per country
    4. Compute unique cities count and unique countries count

    **Rendering:**
    1. Summary stat row (3 StatCards): "Unique Cities" (count), "Unique Countries" (count), "Geo Coverage" (percentage of visits with geo data, e.g. "94%")
    2. Country breakdown: If more than 1 country, show a small horizontal bar chart of visits per country. Since data shows 796 US / 1 Canada / 1 Ireland, this will be a US-dominant bar. Use BreakdownCard component for this (import from shared).
    3. Top cities table: Show top 15 cities sorted by visit count. Each row shows:
       - City name (formatted as "City, Region")
       - Visit count
       - Percentage bar (width proportional to top city's count)
       Use the same inline bar pattern as ReferrerAnalysis for visual consistency.
       Color: #3b82f6 (blue) for all city bars.
    4. If zero geo data, show "No geographic data available" message.

    Wrap in standard section container: `<div className="bg-white rounded-lg shadow p-6 mb-8">`
    Section title: "Geographic Distribution"

    **Part B: Wire both sections into ShrikeAnalytics Deep Dive tab**

    In ShrikeAnalytics.tsx:
    1. Add imports for both new section components:
       ```
       import { ReferrerAnalysis } from './sections/ReferrerAnalysis'
       import { GeoDistribution } from './sections/GeoDistribution'
       ```
    2. In the Deep Dive tab content (the else branch around line 122), add both components after the existing TimeOnPage:
       ```tsx
       <>
         <SessionJourneys visits={visits} />
         <TimeOnPage visits={visits} />
         <ReferrerAnalysis visits={visits} />
         <GeoDistribution visits={visits} />
       </>
       ```

    Order rationale: Session Journeys and Time on Page are session-level analytics (Phase 10). Referrer and Geo are traffic-source analytics (Phase 11). Group by concern.
  </action>
  <verify>
    Run `npx tsc --noEmit` from crm-dashboard/ to confirm everything compiles.
    Run `npm run build` from crm-dashboard/ to confirm production build succeeds.
    Deep Dive tab should render 4 sections: SessionJourneys, TimeOnPage, ReferrerAnalysis, GeoDistribution.
  </verify>
  <done>
    GeoDistribution.tsx exists with city/country breakdown and top 15 cities table.
    ShrikeAnalytics.tsx imports and renders both ReferrerAnalysis and GeoDistribution in the Deep Dive tab.
    Production build succeeds with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — no type errors across entire crm-dashboard
2. `npm run build` succeeds — production build compiles
3. Visit interface includes all 6 new fields (referrer, country, city, region, latitude, longitude)
4. Supabase query selects all 12 columns
5. ReferrerAnalysis categorizes referrers into 5 source types with engagement quality metrics
6. GeoDistribution shows top 15 cities with country breakdown
7. Both sections render in Deep Dive tab after SessionJourneys and TimeOnPage
8. Empty/null data handled gracefully (no crashes, shows "No data" messages)
</verification>

<success_criteria>
- Deep Dive tab shows 4 sections: SessionJourneys, TimeOnPage, ReferrerAnalysis, GeoDistribution
- Referrer analysis categorizes all 9 known referrer values into correct source types
- Referrer analysis shows engagement quality (avg events/session) per source
- Geo distribution shows "Farmville, VA" as top city with ~231 visits
- Site filter (All Sites / Press Club / Rosemont) applies to new sections via shared visits state
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/11-referrer-analysis-geo-distribution/11-01-SUMMARY.md`
</output>
