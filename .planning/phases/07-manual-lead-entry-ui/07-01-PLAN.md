---
phase: 07-manual-lead-entry-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/app/(dashboard)/leads/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees 'Add Lead' button on every client's leads page"
    - "Clicking 'Add Lead' opens a form dialog with all specified fields"
    - "All form fields are optional -- submitting an empty form works"
    - "Submitted lead appears in leads list immediately after submit"
    - "Add Lead button is disabled/hidden when no client is selected (admin 'All Leads' view)"
  artifacts:
    - path: "crm-dashboard/app/(dashboard)/leads/page.tsx"
      provides: "Add Lead dialog, form, submit handler, and button"
      contains: "dialog"
  key_links:
    - from: "crm-dashboard/app/(dashboard)/leads/page.tsx"
      to: "supabase.from('leads').insert"
      via: "Form onSubmit handler inserts lead row"
      pattern: "supabase.*from.*leads.*insert"
    - from: "crm-dashboard/app/(dashboard)/leads/page.tsx"
      to: "fetchLeads"
      via: "After successful insert, fetchLeads() refreshes the list"
      pattern: "fetchLeads\\(\\)"
---

# Phase 07 Plan 01: Add Lead Dialog on Leads Page

**One-liner:** Add an "Add Lead" button and native `<dialog>` form to the leads page so admins can manually enter leads for any client.

<objective>
Add a manual lead entry form to the existing leads page. A blue "Add Lead" button appears next to "Export CSV" in the header. Clicking it opens a native HTML dialog with fields for first name, last name, email, phone, preferred contact, SMS consent, has_website, and social_media_presence. All fields are optional. On submit, the lead is inserted via Supabase client with `utm_source: 'manual-entry'` and the leads list refreshes immediately.

Purpose: Enable manual lead entry for all clients (especially Cold Calling) directly from the CRM leads page.
Output: Updated leads/page.tsx with dialog, form, submit handler, and button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@crm-dashboard/app/(dashboard)/leads/page.tsx
@crm-dashboard/types/lead.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Add Lead" dialog, form, submit handler, and button to leads/page.tsx</name>
  <files>crm-dashboard/app/(dashboard)/leads/page.tsx</files>
  <action>
Modify `crm-dashboard/app/(dashboard)/leads/page.tsx` to add manual lead entry. All changes go in this single file -- no new components or files needed.

**1. Add `useRef` to the React imports (line 3):**
Change `import { useEffect, useState, useCallback } from 'react'` to include `useRef`.

**2. Add state and ref inside LeadsPage component (after the existing state declarations around line 24-25):**

```typescript
const dialogRef = useRef<HTMLDialogElement>(null)
const [submitting, setSubmitting] = useState(false)
const [preferredContact, setPreferredContact] = useState('email')
```

**3. Add "Add Lead" button in the header (lines 118-126).**
Insert a second button before the Export CSV button inside the flex container. The header should become:

```tsx
<div className="flex justify-between items-center mb-6">
  <h1 className="text-2xl font-bold text-gray-900">Leads</h1>
  <div className="flex gap-2">
    {currentClientId && (
      <button
        onClick={() => dialogRef.current?.showModal()}
        className="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700"
      >
        Add Lead
      </button>
    )}
    <button
      onClick={exportCSV}
      className="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700"
    >
      Export CSV
    </button>
  </div>
</div>
```

The `{currentClientId && ...}` conditional ensures the button only renders when a client is selected. When admin is viewing "All Leads" (no client selected), the button is hidden because we need a `client_id` to assign the lead to.

**4. Add the submit handler function (after the `exportCSV` function, before the `return` statement):**

```typescript
const handleAddLead = async (e: React.FormEvent<HTMLFormElement>) => {
  e.preventDefault()
  setSubmitting(true)

  const form = e.currentTarget
  const formData = new FormData(form)

  const preferredContact = formData.get('preferred_contact') as string || 'email'
  const smsConsent = formData.get('sms_consent') === 'on'
  const hasWebsite = formData.get('has_website') === 'on'
  const socialMedia = formData.get('social_media_presence') as string

  const { error } = await supabase.from('leads').insert({
    client_id: currentClientId,
    first_name: formData.get('first_name') as string || '',
    last_name: formData.get('last_name') as string || '',
    email: formData.get('email') as string || '',
    phone: (formData.get('phone') as string) || null,
    preferred_contact: preferredContact,
    sms_consent: smsConsent,
    sms_consent_at: smsConsent ? new Date().toISOString() : null,
    has_website: hasWebsite || null,
    social_media_presence: socialMedia ? parseInt(socialMedia, 10) : null,
    status: 'new',
    utm_source: 'manual-entry',
  })

  setSubmitting(false)

  if (error) {
    console.error('Error adding lead:', error)
    alert('Failed to add lead: ' + error.message)
    return
  }

  form.reset()
  setPreferredContact('email')
  dialogRef.current?.close()
  fetchLeads()
}
```

Notes on the handler:
- `first_name`, `last_name`, and `email` default to empty string (matching the DB NOT NULL or empty-string pattern from the existing form submissions).
- `phone` defaults to `null` when empty (nullable column).
- `has_website` is stored as `true` when checked, `null` when unchecked (not `false` -- null means "not assessed," matching the DB default).
- `social_media_presence` is parsed to int or left null.
- `sms_consent_at` is only set when sms_consent is true.
- `utm_source: 'manual-entry'` tags the lead so it's distinguishable from website form leads in reporting.

**5. Add the `<dialog>` element at the bottom of the JSX, right before the closing `</div>` of the return statement (before line 240's `</div>`):**

```tsx
{/* Add Lead Dialog */}
<dialog
  ref={dialogRef}
  className="rounded-lg shadow-xl p-0 w-full max-w-md backdrop:bg-black/50"
  onClick={(e) => { if (e.target === e.currentTarget) dialogRef.current?.close() }}
>
  <form onSubmit={handleAddLead} className="p-6">
    <h2 className="text-lg font-semibold text-gray-900 mb-4">Add Lead</h2>

    <div className="space-y-4">
      {/* Name row */}
      <div className="grid grid-cols-2 gap-3">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">First Name</label>
          <input
            type="text"
            name="first_name"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
          <input
            type="text"
            name="last_name"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
      </div>

      {/* Email */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input
          type="email"
          name="email"
          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      {/* Phone */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
        <input
          type="tel"
          name="phone"
          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      {/* Preferred Contact (controlled â€” drives SMS consent visibility) */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Preferred Contact</label>
        <div className="flex gap-4">
          <label className="flex items-center gap-1 text-sm">
            <input type="radio" name="preferred_contact" value="email" checked={preferredContact === 'email'} onChange={(e) => setPreferredContact(e.target.value)} />
            Email
          </label>
          <label className="flex items-center gap-1 text-sm">
            <input type="radio" name="preferred_contact" value="phone" checked={preferredContact === 'phone'} onChange={(e) => setPreferredContact(e.target.value)} />
            Phone
          </label>
          <label className="flex items-center gap-1 text-sm">
            <input type="radio" name="preferred_contact" value="sms" checked={preferredContact === 'sms'} onChange={(e) => setPreferredContact(e.target.value)} />
            SMS
          </label>
        </div>
      </div>

      {/* SMS Consent -- only shown when preferred_contact is sms */}
      {preferredContact === 'sms' && (
        <div>
          <label className="flex items-center gap-2 text-sm">
            <input type="checkbox" name="sms_consent" className="rounded" />
            <span className="text-gray-700">SMS Consent</span>
          </label>
        </div>
      )}

      {/* Has Website */}
      <div>
        <label className="flex items-center gap-2 text-sm">
          <input type="checkbox" name="has_website" className="rounded" />
          <span className="text-gray-700">Has a website</span>
        </label>
      </div>

      {/* Social Media Presence */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Social Media Presence</label>
        <div className="flex gap-3">
          {[1, 2, 3, 4, 5].map((n) => (
            <label key={n} className="flex items-center gap-1 text-sm">
              <input type="radio" name="social_media_presence" value={n} />
              {n}
            </label>
          ))}
        </div>
        <p className="text-xs text-gray-400 mt-1">1 = minimal, 5 = strong presence</p>
      </div>
    </div>

    {/* Actions */}
    <div className="flex justify-end gap-2 mt-6">
      <button
        type="button"
        onClick={() => { dialogRef.current?.close(); setPreferredContact('email') }}
        className="px-4 py-2 text-sm text-gray-600 hover:text-gray-900"
      >
        Cancel
      </button>
      <button
        type="submit"
        disabled={submitting}
        className="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700 disabled:opacity-50"
      >
        {submitting ? 'Adding...' : 'Add Lead'}
      </button>
    </div>
  </form>
</dialog>
```

Key implementation notes:
- No `required` attribute on ANY field. All fields are optional per requirements.
- Native `<dialog>` element -- no external dialog library needed.
- `backdrop:bg-black/50` for the overlay (Tailwind `backdrop:` variant styles the `::backdrop` pseudo-element).
- Clicking the backdrop (the dialog element itself, not its children) closes it.
- Social media presence uses 5 radio buttons (1-5) with no default selected -- leaving it unselected means null in the handler.
- Preferred Contact uses controlled state (`preferredContact` / `setPreferredContact`) so SMS consent checkbox is conditionally rendered only when `preferredContact === 'sms'`.
- Cancel button and successful submit both reset `preferredContact` back to `'email'`.

  </action>
  <verify>
- `npx tsc --noEmit` from crm-dashboard directory passes with no TypeScript errors
- `npm run build` from crm-dashboard directory succeeds
- Visually inspect the file to confirm:
  - `dialogRef` and `<dialog>` element present
  - "Add Lead" button wrapped in `{currentClientId && ...}` conditional
  - Form has all 8 fields (first_name, last_name, email, phone, preferred_contact, sms_consent, has_website, social_media_presence)
  - No `required` attributes on any input
  - Submit handler calls `supabase.from('leads').insert(...)` with `client_id: currentClientId`
  - After successful insert, `fetchLeads()` is called
  - SMS consent checkbox is conditionally rendered when preferred_contact === 'sms'
  </verify>
  <done>
Leads page has "Add Lead" button (blue, next to Export CSV) that opens a native dialog form. Form captures all 8 fields with no required validation. Submit inserts via Supabase client with utm_source 'manual-entry' and refreshes the leads list. Button hidden when no client is selected.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification -- Add Lead form on leads page</name>
  <what-built>
"Add Lead" button and native dialog form on the leads page. The form captures first name, last name, email, phone, preferred contact (radio), SMS consent (checkbox, shown only for SMS), has_website (checkbox), and social_media_presence (1-5 radio). All fields optional. Submit inserts lead via Supabase and refreshes the list.
  </what-built>
  <how-to-verify>
1. Open the CRM dashboard and navigate to any client's Leads page (e.g., Cold Calling > Leads)
2. Verify the blue "Add Lead" button appears next to "Export CSV" in the header
3. Click "Add Lead" -- a modal dialog should appear with a dark backdrop
4. Verify all form fields are present: first name, last name, email, phone, preferred contact (email/phone/sms radios), has_website checkbox, social media presence (1-5 radios)
5. Verify SMS consent checkbox appears only when "SMS" is selected for preferred contact
6. Click "Cancel" -- dialog should close
7. Reopen and submit the form with NO fields filled -- it should succeed (no validation errors)
8. Submit a lead with some fields filled (e.g., first name "Test", last name "Lead", email "test@example.com")
9. After submission, the dialog should close and the new lead should appear at the top of the leads list
10. Verify the new lead shows "manual-entry" as the source in the Source column
11. Navigate to the admin "All Leads" view (no client selected) and verify the "Add Lead" button is NOT visible
  </how-to-verify>
  <resume-signal>Type "approved" if the Add Lead form works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- "Add Lead" button visible on all client leads pages
- Dialog opens with all 8 fields, no required validation
- Empty form submission succeeds
- Populated form submission succeeds and lead appears in list immediately
- Button hidden when admin has no client selected
- SMS consent only shown when preferred contact is SMS
- New lead has utm_source = 'manual-entry'
</verification>

<success_criteria>
1. User sees blue "Add Lead" button on every client's leads page, next to "Export CSV"
2. Clicking "Add Lead" opens a dialog with: first name, last name, email, phone, preferred contact, SMS consent (conditional), has_website, social_media_presence
3. All form fields are optional -- submitting empty form works
4. After submitting, new lead appears in the leads list immediately (fetchLeads called on success)
5. Button is hidden when no client is selected (admin "All Leads" view)
6. New leads are tagged with utm_source = 'manual-entry'
</success_criteria>

<output>
After completion, create `.planning/phases/07-manual-lead-entry-ui/07-01-SUMMARY.md`
</output>
