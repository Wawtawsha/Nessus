---
phase: 05-shrike-website-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/supabase/migrations/05_shrike_consolidation.sql
autonomous: false

must_haves:
  truths:
    - "'Shrike Media Website' client exists in the clients table with is_active=true"
    - "Both old clients ('2016 Night at Press Club' and 'Rosemont Vineyard') have is_active=false"
    - "All visits formerly belonging to old clients now have client_id pointing to 'Shrike Media Website'"
    - "Every migrated visit has a website_label of 'press-club' or 'rosemont'"
    - "All leads formerly belonging to old clients now have client_id pointing to 'Shrike Media Website'"
    - "All toast_orders formerly belonging to old clients now have client_id pointing to 'Shrike Media Website'"
    - "All toast_order_items formerly belonging to old clients now have client_id pointing to 'Shrike Media Website'"
    - "All toast_payments formerly belonging to old clients now have client_id pointing to 'Shrike Media Website'"
    - "Total row counts per table before migration equal counts after migration"
    - "Composite index exists on (client_id, website_label)"
  artifacts:
    - path: "crm-dashboard/supabase/migrations/05_shrike_consolidation.sql"
      provides: "Complete transactional migration script for all tables"
      contains: "BEGIN"
  key_links:
    - from: "visits.client_id"
      to: "clients.id (Shrike Media Website)"
      via: "UPDATE SET client_id"
      pattern: "UPDATE visits SET.*client_id"
    - from: "visits.website_label"
      to: "old client identity"
      via: "CASE WHEN mapping"
      pattern: "CASE.*WHEN.*THEN.*press-club"
    - from: "leads.client_id"
      to: "clients.id (Shrike Media Website)"
      via: "UPDATE SET client_id"
      pattern: "UPDATE leads SET.*client_id"
    - from: "toast_orders.client_id"
      to: "clients.id (Shrike Media Website)"
      via: "UPDATE SET client_id"
      pattern: "UPDATE toast_orders SET.*client_id"
---

<objective>
Create and apply the database migration that consolidates "2016 Night at Press Club" and "Rosemont Vineyard" into a single "Shrike Media Website" client. Migrate ALL data across ALL tables. Add website_label column to visits table to preserve per-page identity.

Purpose: This is the foundation for Phase 5 -- the UI refactoring in Plan 02 depends on this schema change being applied.
Output: A complete SQL migration script and a verified database state with consolidated data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-shrike-website-consolidation/05-RESEARCH.md
@crm-dashboard/contexts/UserContext.tsx
@crm-dashboard/components/ClientAccordion.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create full database migration SQL script</name>
  <files>crm-dashboard/supabase/migrations/05_shrike_consolidation.sql</files>
  <action>
Create a complete, transactional SQL migration script that does the following in order:

CONTEXT: "2016 Night at Press Club" and "Rosemont Vineyard" are NOT separate businesses -- they are pages on the same website (Shrike Media's website). They were incorrectly set up as separate clients. This migration consolidates ALL their data under one "Shrike Media Website" client.

1. Add `website_label TEXT` column to the `visits` table (nullable).

2. Look up old client IDs by name (do NOT hardcode UUIDs -- look them up dynamically):
   - Find client where name = '2016 Night at Press Club'
   - Find client where name = 'Rosemont Vineyard'
   Use CTEs to store these IDs for reuse across all UPDATE statements.

3. Create new "Shrike Media Website" client:
   - INSERT INTO clients with name='Shrike Media Website', slug='shrike-media-website', is_active=true
   Store the new client ID in a CTE for reuse.

4. Update visits table:
   - Set website_label = 'press-club' for Press Club visits
   - Set website_label = 'rosemont' for Rosemont visits
   - Set client_id = new Shrike Media Website client ID for ALL migrated visits

5. Update leads table:
   - Set client_id = new Shrike Media Website client ID for ALL leads belonging to old clients

6. Update toast_orders table:
   - Set client_id = new Shrike Media Website client ID for ALL orders belonging to old clients

7. Update toast_order_items table:
   - Set client_id = new Shrike Media Website client ID for ALL order items belonging to old clients

8. Update toast_payments table:
   - Set client_id = new Shrike Media Website client ID for ALL payments belonging to old clients

9. Verify counts match for EACH table (use DO $$ block with RAISE EXCEPTION if counts diverge):
   - Count visits before/after
   - Count leads before/after
   - Count toast_orders before/after
   - Count toast_order_items before/after
   - Count toast_payments before/after

10. Create indexes:
    - CREATE INDEX idx_visits_website_label ON visits(website_label)
    - CREATE INDEX idx_visits_client_website ON visits(client_id, website_label)

11. Deactivate old clients (SET is_active = false, do NOT delete them).

CRITICAL -- NOT NULL CONSTRAINT:
Do NOT add a NOT NULL constraint on website_label. The column MUST remain nullable (TEXT without NOT NULL).

Why: The visit tracking mechanism is external to this codebase and will continue to create visits without a website_label until it is updated separately. Adding NOT NULL would break new visit ingestion.

NOTE: The RESEARCH.md file (05-RESEARCH.md) contains example SQL at lines 384-386 that INCORRECTLY includes `ALTER COLUMN website_label SET NOT NULL`. That research example is WRONG for our use case. Do NOT follow the research example on this point. The plan takes precedence over the research.

Known follow-up (NOT in scope for this plan): Future visits created by the external tracking script will have NULL website_label until that script is updated to include it. These untagged visits will still be associated with "Shrike Media Website" (via client_id) and will appear in aggregate queries, but will NOT appear in per-site cards on the visits page. The tracking script update will happen after Phase 5 execution.

NOTE on lead_events: The lead_events table references lead_id (not client_id directly). Since leads are being migrated to the new client, lead_events will follow automatically through the foreign key. No direct update to lead_events is needed.

Wrap the entire migration in BEGIN...COMMIT. Use CTEs or DO $$ blocks to look up client IDs dynamically by name.

Add clear comments explaining each step and the rollback strategy (re-activate old clients, move data back by checking which rows were migrated).
  </action>
  <verify>
Read the generated SQL file and verify ALL of the following:
- Uses BEGIN/COMMIT transaction
- Looks up client IDs by name (not hardcoded UUIDs)
- Creates "Shrike Media Website" client (NOT "Shrike Website")
- Updates ALL 5 tables: visits, leads, toast_orders, toast_order_items, toast_payments
- visits get website_label based on old client_id
- Includes count verification for ALL tables
- Creates both indexes
- Deactivates (not deletes) old clients

NOT NULL CHECK (MANDATORY):
- Grep the file for "NOT NULL" (case-insensitive). The ONLY acceptable match is in a comment explaining why NOT NULL is NOT used.
- Verify the script does NOT contain `ALTER COLUMN website_label SET NOT NULL`
- Verify the script does NOT contain `NOT NULL` in the ADD COLUMN statement for website_label
- If ANY NOT NULL constraint is found on website_label, this task FAILS. Fix it before proceeding.
  </verify>
  <done>Complete SQL migration script exists at the specified path, is syntactically valid PostgreSQL, handles the full consolidation of ALL tables in a single transaction, and the website_label column is nullable.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>A SQL migration script that fully consolidates two clients into "Shrike Media Website" with per-page visit labeling and all data migrated.</what-built>
  <how-to-verify>
    1. Review the SQL script at crm-dashboard/supabase/migrations/05_shrike_consolidation.sql
    2. Before running, check current counts in Supabase SQL editor:
       ```sql
       SELECT c.name,
         (SELECT COUNT(*) FROM visits WHERE client_id = c.id) as visits,
         (SELECT COUNT(*) FROM leads WHERE client_id = c.id) as leads,
         (SELECT COUNT(*) FROM toast_orders WHERE client_id = c.id) as orders,
         (SELECT COUNT(*) FROM toast_order_items WHERE client_id = c.id) as items,
         (SELECT COUNT(*) FROM toast_payments WHERE client_id = c.id) as payments
       FROM clients c
       WHERE c.name IN ('2016 Night at Press Club', 'Rosemont Vineyard');
       ```
    3. Run the migration script in Supabase SQL Editor (copy-paste the full script)
    4. After running, verify:
       ```sql
       -- New client exists
       SELECT * FROM clients WHERE slug = 'shrike-media-website';

       -- Old clients deactivated
       SELECT name, is_active FROM clients
       WHERE name IN ('2016 Night at Press Club', 'Rosemont Vineyard');

       -- All data consolidated
       SELECT
         (SELECT COUNT(*) FROM visits WHERE client_id = c.id) as visits,
         (SELECT COUNT(*) FROM leads WHERE client_id = c.id) as leads,
         (SELECT COUNT(*) FROM toast_orders WHERE client_id = c.id) as orders,
         (SELECT COUNT(*) FROM toast_order_items WHERE client_id = c.id) as items,
         (SELECT COUNT(*) FROM toast_payments WHERE client_id = c.id) as payments
       FROM clients c WHERE c.slug = 'shrike-media-website';

       -- Visit labels
       SELECT website_label, COUNT(*) FROM visits
       WHERE client_id = (SELECT id FROM clients WHERE slug = 'shrike-media-website')
       GROUP BY website_label;

       -- Confirm website_label is nullable
       SELECT column_name, is_nullable FROM information_schema.columns
       WHERE table_name = 'visits' AND column_name = 'website_label';
       ```
    5. Confirm total counts per table match the pre-migration counts.

    NOTE: If either old client has NO data in some tables, the migration will still work -- it will just have 0 rows to update for that client/table. That's fine.
  </how-to-verify>
  <resume-signal>Type "migration applied" with the counts, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- SQL file exists and is valid PostgreSQL
- Migration handles dynamic client ID lookup (not hardcoded)
- Transaction wraps all changes
- ALL 5 tables migrated (visits, leads, toast_orders, toast_order_items, toast_payments)
- Count verification prevents data loss across all tables
- Indexes created for query performance
- Old clients preserved (deactivated, not deleted)
- website_label column is nullable (NO NOT NULL constraint)
- Client name is "Shrike Media Website" (not "Shrike Website")
</verification>

<success_criteria>
- "Shrike Media Website" client exists in sidebar (is_active=true)
- Both old clients are is_active=false
- All data from ALL tables points to Shrike Media Website
- Each visit has website_label of 'press-club' or 'rosemont'
- Row counts match pre/post migration for every table
- website_label column allows NULL values
</success_criteria>

<output>
After completion, create `.planning/phases/05-shrike-website-consolidation/05-01-SUMMARY.md`
</output>
