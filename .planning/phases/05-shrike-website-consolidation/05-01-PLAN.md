---
phase: 05-shrike-website-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/supabase/migrations/05_shrike_consolidation.sql
autonomous: false

must_haves:
  truths:
    - "'Shrike Website' client exists in the clients table with is_active=true"
    - "Both old clients ('2016 Night at Press Club' and 'Rosemont Vineyard') have is_active=false"
    - "All visits formerly belonging to old clients now have client_id pointing to 'Shrike Website'"
    - "Every migrated visit has a website_label of 'press-club' or 'rosemont'"
    - "Total visit count before migration equals total visit count after migration"
    - "Composite index exists on (client_id, website_label)"
  artifacts:
    - path: "crm-dashboard/supabase/migrations/05_shrike_consolidation.sql"
      provides: "Complete transactional migration script"
      contains: "BEGIN"
  key_links:
    - from: "visits.client_id"
      to: "clients.id (Shrike Website)"
      via: "UPDATE SET client_id"
      pattern: "UPDATE visits SET.*client_id"
    - from: "visits.website_label"
      to: "old client identity"
      via: "CASE WHEN mapping"
      pattern: "CASE.*WHEN.*THEN.*press-club"
---

<objective>
Create and apply the database migration that consolidates "2016 Night at Press Club" and "Rosemont Vineyard" into a single "Shrike Website" client. Add website_label column to visits table to preserve per-site identity.

Purpose: This is the foundation for Phase 5 -- the UI refactoring in Plan 02 depends on this schema change being applied.
Output: A complete SQL migration script and a verified database state with consolidated data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-shrike-website-consolidation/05-RESEARCH.md
@crm-dashboard/contexts/UserContext.tsx
@crm-dashboard/components/ClientAccordion.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration SQL script</name>
  <files>crm-dashboard/supabase/migrations/05_shrike_consolidation.sql</files>
  <action>
Create a complete, transactional SQL migration script that does the following in order:

1. Add `website_label TEXT` column to the `visits` table (nullable initially).

2. Look up old client IDs by name (do NOT hardcode UUIDs -- look them up dynamically):
   - Find client where name = '2016 Night at Press Club'
   - Find client where name = 'Rosemont Vineyard'
   Query the actual slugs from the database if needed. The slugs may not match what the research assumed.

3. Create new "Shrike Website" client:
   - INSERT INTO clients with name='Shrike Website', slug='shrike-website', is_active=true

4. Update all visits belonging to old clients:
   - Set website_label = 'press-club' for Press Club visits
   - Set website_label = 'rosemont' for Rosemont visits
   - Set client_id = new Shrike Website client ID for ALL migrated visits

5. Verify counts match (use DO $$ block with RAISE EXCEPTION if counts diverge).

6. Create indexes:
   - CREATE INDEX idx_visits_website_label ON visits(website_label)
   - CREATE INDEX idx_visits_client_website ON visits(client_id, website_label)

7. Deactivate old clients (SET is_active = false, do NOT delete them).

CRITICAL -- NOT NULL CONSTRAINT:
Do NOT add a NOT NULL constraint on website_label. The column MUST remain nullable (TEXT without NOT NULL).

Why: The visit tracking mechanism is external to this codebase and will continue to create visits without a website_label until it is updated separately. Adding NOT NULL would break new visit ingestion.

NOTE: The RESEARCH.md file (05-RESEARCH.md) contains example SQL at lines 384-386 that INCORRECTLY includes `ALTER COLUMN website_label SET NOT NULL`. That research example is WRONG for our use case. Do NOT follow the research example on this point. The plan takes precedence over the research.

Known follow-up (NOT in scope for this plan): Future visits created by the external tracking script will have NULL website_label until that script is updated to include it. These untagged visits will still be associated with the "Shrike Website" client (via client_id) and will appear in aggregate queries, but they will NOT appear in per-site cards on the visits page. This is acceptable for now -- the tracking script update is a separate concern outside this codebase.

Wrap the entire migration in BEGIN...COMMIT. Use CTEs to look up client IDs dynamically by name.

Add clear comments explaining each step and the rollback strategy (re-activate old clients, move visits back by website_label).
  </action>
  <verify>
Read the generated SQL file and verify ALL of the following:
- Uses BEGIN/COMMIT transaction
- Looks up client IDs by name (not hardcoded UUIDs)
- Creates Shrike Website client
- Updates visits with website_label based on old client_id
- Includes count verification
- Creates both indexes
- Deactivates (not deletes) old clients

NOT NULL CHECK (MANDATORY):
- Grep the file for "NOT NULL" (case-insensitive). The ONLY acceptable match is in a comment explaining why NOT NULL is NOT used.
- Verify the script does NOT contain `ALTER COLUMN website_label SET NOT NULL`
- Verify the script does NOT contain `NOT NULL` in the ADD COLUMN statement for website_label
- If ANY NOT NULL constraint is found on website_label, this task FAILS. Fix it before proceeding.
  </verify>
  <done>Complete SQL migration script exists at the specified path, is syntactically valid PostgreSQL, handles the full consolidation in a single transaction, and the website_label column is nullable (no NOT NULL constraint anywhere).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>A SQL migration script that consolidates two clients into "Shrike Website" with per-site visit labeling.</what-built>
  <how-to-verify>
    1. Review the SQL script at crm-dashboard/supabase/migrations/05_shrike_consolidation.sql
    2. Before running, check current visit counts in Supabase SQL editor:
       ```sql
       SELECT c.name, COUNT(v.id) as visit_count
       FROM visits v JOIN clients c ON v.client_id = c.id
       WHERE c.name IN ('2016 Night at Press Club', 'Rosemont Vineyard')
       GROUP BY c.name;
       ```
    3. Run the migration script in Supabase SQL Editor (copy-paste the full script)
    4. After running, verify:
       ```sql
       -- New client exists
       SELECT * FROM clients WHERE slug = 'shrike-website';

       -- Old clients deactivated
       SELECT name, is_active FROM clients
       WHERE name IN ('2016 Night at Press Club', 'Rosemont Vineyard');

       -- Visits consolidated with labels
       SELECT website_label, COUNT(*) FROM visits
       WHERE client_id = (SELECT id FROM clients WHERE slug = 'shrike-website')
       GROUP BY website_label;

       -- Indexes exist
       SELECT indexname FROM pg_indexes WHERE tablename = 'visits'
       AND indexname LIKE 'idx_visits%';

       -- Confirm website_label is nullable (no NOT NULL)
       SELECT column_name, is_nullable FROM information_schema.columns
       WHERE table_name = 'visits' AND column_name = 'website_label';
       ```
    5. Confirm total visit count matches the pre-migration count.

    NOTE: If either old client has NO visits, the migration will still work -- it will just have 0 rows to update for that client. That's fine.
  </how-to-verify>
  <resume-signal>Type "migration applied" with the visit counts, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- SQL file exists and is valid PostgreSQL
- Migration handles dynamic client ID lookup (not hardcoded)
- Transaction wraps all changes
- Count verification prevents data loss
- Indexes created for query performance
- Old clients preserved (deactivated, not deleted)
- website_label column is nullable (NO NOT NULL constraint)
</verification>

<success_criteria>
- "Shrike Website" client exists in sidebar (is_active=true)
- Both old clients are is_active=false
- All visits from old clients have client_id pointing to Shrike Website
- Each visit has website_label of 'press-club' or 'rosemont'
- Visit counts match pre/post migration
- website_label column allows NULL values (confirmed via information_schema)
</success_criteria>

<output>
After completion, create `.planning/phases/05-shrike-website-consolidation/05-01-SUMMARY.md`
</output>
