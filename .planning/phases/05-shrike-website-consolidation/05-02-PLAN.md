---
phase: 05-shrike-website-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - crm-dashboard/app/(dashboard)/visits/page.tsx
autonomous: false

must_haves:
  truths:
    - "Visits page shows two distinct website cards side-by-side on desktop"
    - "Each card displays full metrics: total visits, unique IPs, sessions, locations, referrers, pages, time series"
    - "All metrics viewable on one screen without clicking between clients"
    - "Cards stack vertically on mobile"
    - "Data refreshes on 30-second polling interval"
    - "Page works correctly when Shrike Website client is selected in sidebar"
  artifacts:
    - path: "crm-dashboard/app/(dashboard)/visits/page.tsx"
      provides: "Per-site card-based visits dashboard"
      contains: "WEBSITES"
      min_lines: 200
  key_links:
    - from: "WebsiteCard component"
      to: "Supabase visits table"
      via: "addSiteFilters with website_label"
      pattern: "eq.*website_label.*websiteLabel"
    - from: "WEBSITES constant"
      to: "WebsiteCard rendering"
      via: "map iteration"
      pattern: "WEBSITES\\.map"
    - from: "visits page"
      to: "UserContext"
      via: "useUser hook for currentClientId"
      pattern: "useUser.*currentClientId"
---

<objective>
Redesign the visits page to display each website's metrics in its own card within a responsive grid layout. Replace the current single-client aggregate view with per-site WebsiteCard components that each show full metrics (overview stats, locations, pages, referrers, session stats, time series).

Purpose: Fulfill success criteria #3 and #4 -- per-site metric cards viewable on one screen.
Output: Refactored visits/page.tsx with card-based layout and per-site data fetching.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-shrike-website-consolidation/05-RESEARCH.md
@.planning/phases/05-shrike-website-consolidation/05-01-SUMMARY.md
@crm-dashboard/app/(dashboard)/visits/page.tsx
@crm-dashboard/contexts/UserContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor visits page to per-site card layout</name>
  <files>crm-dashboard/app/(dashboard)/visits/page.tsx</files>
  <action>
Rewrite the visits page.tsx to use a per-site card-based layout. This is a FULL rewrite of the file, not a patch.

**1. Define WEBSITES constant at the top of the file:**
```tsx
const WEBSITES = [
  { label: 'press-club', name: '2016 Night at Press Club' },
  { label: 'rosemont', name: 'Rosemont Vineyard' },
] as const
```
Do NOT put this in a separate config file. It's only used here.

**2. Create an `addSiteFilters` helper function** that extends a Supabase query with both client_id and website_label filters:
```tsx
const addSiteFilters = <T,>(query: T, clientId: string | null, websiteLabel: string): T => {
  let filtered = query as any
  if (clientId) {
    filtered = filtered.eq('client_id', clientId)
  }
  filtered = filtered.eq('website_label', websiteLabel)
  return filtered
}
```
This replaces the existing `addClientFilter` which only filtered by client_id.

**3. Create a `WebsiteCard` component** that accepts websiteLabel, websiteName, currentClientId, and supabase as props. Each card independently fetches and displays ALL of the following metrics for its specific website (using addSiteFilters on every query):

- **Overview stats:** Total visits, unique IPs, unique sessions (3-column grid inside the card)
- **Locations:** Top 10 locations with horizontal bar chart (same style as current)
- **Top Pages:** Top 10 pages with horizontal bar chart
- **Top Referrers:** Top 10 referrers with horizontal bar chart (hostname extraction for URLs)
- **Session stats:** Avg visits/session, returning visitor percentage
- **Visits over time:** Last 30 days bar chart

Each card should have its own loading state (skeleton placeholder) and poll independently every 30 seconds.

IMPORTANT: Carry over ALL the existing metric computation logic from the current page -- the location counting, page counting, referrer counting, daily stats, session stats calculations. Do not simplify or remove any of them. The only change is scoping each query with website_label.

**4. Restructure the page layout:**
- Page title: "Shrike Website Visitor Analytics" (or just "Visitor Analytics" -- keep it consistent with the existing pattern of just "Visitor Analytics" since the client name shows in the sidebar)
- Actually, keep the title as "Visitor Analytics" to stay consistent with the rest of the app. The sidebar already shows which client is selected.
- Two-column grid on desktop (lg:grid-cols-2), single column on mobile
- Each WebsiteCard in the grid with gap-6 spacing

**5. Preserve existing guards:**
- Keep the non-admin + no-client-selected guard
- Keep the loading state (but now it should be at the card level, not page level)

**6. Keep the StatCard component** at the bottom of the file (it's a small internal component). No changes needed to it.

**Layout within each WebsiteCard:**
```
[Card Header: Website Name]
[3-col stats: Visits | Unique IPs | Sessions]
[2-col grid inside card:]
  [Locations | Top Pages]
  [Referrers | Session Stats]
[Full-width: Visits Over Time chart]
```

Use the same Tailwind classes and styling patterns as the current page. The cards should look like a natural part of the existing dashboard.

For the inner 2-column grid within each card, use `grid grid-cols-1 md:grid-cols-2 gap-4` so the sub-sections also stack on small screens.

Each sub-section (locations, pages, referrers, session stats) should have its own `bg-gray-50 rounded-lg p-4` container within the card to visually separate them from each other. The card itself uses `bg-white rounded-lg shadow p-6`.
  </action>
  <verify>
1. Run `cd crm-dashboard && npx tsc --noEmit` to verify TypeScript compiles without errors.
2. Read the file and verify:
   - WEBSITES constant is defined with both sites
   - addSiteFilters helper exists and filters by both client_id and website_label
   - WebsiteCard component fetches all 5 metric categories independently per site
   - Grid layout uses lg:grid-cols-2 for desktop, grid-cols-1 for mobile
   - 30-second polling is present
   - All existing metric computations preserved (locations, pages, referrers, daily stats, session stats)
   - StatCard component preserved
  </verify>
  <done>
Visits page renders two WebsiteCard components in a responsive grid. Each card shows full metrics (visits, IPs, sessions, locations, pages, referrers, session stats, time series) for its specific website, filtered by website_label. TypeScript compiles without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Redesigned visits page with per-site metric cards in a responsive grid layout.</what-built>
  <how-to-verify>
    1. Run `cd crm-dashboard && npm run dev`
    2. Navigate to the app, log in as admin
    3. Select "Shrike Website" in the sidebar
    4. Click "Visits" in the sidebar navigation
    5. Verify you see TWO cards side-by-side:
       - "2016 Night at Press Club" card with its metrics
       - "Rosemont Vineyard" card with its metrics
    6. Each card should show: overview stats, locations, top pages, referrers, session stats, and time series chart
    7. Resize browser to mobile width -- cards should stack vertically
    8. Wait 30+ seconds -- data should refresh (check network tab for new Supabase queries)
    9. If either site has zero visits, the card should show "No data yet" messages in the metric sections (not crash)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues.</resume-signal>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Page renders two distinct website cards
- Each card has all metric sections from the original page
- Responsive layout works (2-col desktop, 1-col mobile)
- Data is correctly scoped per website (press-club vs rosemont)
- Polling continues to work at 30-second intervals
- Empty state handled gracefully per card
</verification>

<success_criteria>
- Visits panel shows each webpage's full metrics in its own distinct card
- All metrics viewable on one screen without clicking between clients
- Per-site data is correctly filtered by website_label
- Layout is responsive (2-col on lg, 1-col on mobile)
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-shrike-website-consolidation/05-02-SUMMARY.md`
</output>
