---
phase: 13-database-indexes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All foreign key columns across visits, leads, scripts, niches, and script_lead_outcomes have B-tree indexes"
    - "The main analytics query (visits WHERE client_id = X AND website_label = Y) uses the composite index idx_visits_client_website"
    - "Index audit documented with EXPLAIN ANALYZE results confirming query plan uses indexes"
  artifacts: []
  key_links: []
---

<objective>
Audit existing database indexes and verify they cover all analytics query patterns from phases 9-12 and v1.4 schema from phase 14.

Purpose: This is a verification-only phase. Prior migrations already created all necessary indexes. This plan runs EXPLAIN ANALYZE on key queries, documents the findings, and confirms no additional indexes are needed.

Output: Index audit results documented. No schema changes expected.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Supabase project ID: rjudjhjcfivugbyztnce

Working directory: C:\Users\steph\OneDrive\Desktop\claude\Nessus

**Pre-verified index inventory (from pg_indexes):**

visits table (1,731 rows, 1.2MB):
- idx_visits_client (client_id)
- idx_visits_client_website (client_id, website_label) — composite
- idx_visits_created (created_at)
- idx_visits_session (session_id)
- idx_visits_website_label (website_label)
- visits_pkey (id)

leads table:
- idx_leads_client (client_id)
- idx_leads_email (email)
- idx_leads_niche_id (niche_id)
- idx_leads_status (status)
- idx_leads_created_at (created_at DESC)
- idx_leads_utm_campaign (utm_campaign)

scripts table:
- idx_scripts_client_id (client_id)

niches table:
- idx_niches_name (name)
- niches_name_key (name, UNIQUE)

script_lead_outcomes table:
- idx_slo_script_id (script_id)
- idx_slo_lead_id (lead_id)
- unique_script_lead (script_id, lead_id, UNIQUE)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run EXPLAIN ANALYZE on key analytics queries and document results</name>
  <files></files>
  <action>
Run the following queries against Supabase project rjudjhjcfivugbyztnce using the Supabase MCP execute_sql tool:

1. **Main analytics query (all sites):**
   ```sql
   EXPLAIN ANALYZE
   SELECT event_name, event_data, session_id, page_path, created_at, user_agent, referrer, country, city, region, latitude, longitude
   FROM visits
   WHERE client_id = 'da6fa735-8143-4cdf-941c-5b6021cbc961';
   ```

2. **Main analytics query (filtered by website_label):**
   ```sql
   EXPLAIN ANALYZE
   SELECT event_name, event_data, session_id, page_path, created_at, user_agent, referrer, country, city, region, latitude, longitude
   FROM visits
   WHERE client_id = 'da6fa735-8143-4cdf-941c-5b6021cbc961'
   AND website_label = 'press-club';
   ```

3. **Index usage stats:**
   ```sql
   SELECT indexrelname, idx_scan, idx_tup_read, idx_tup_fetch
   FROM pg_stat_user_indexes
   WHERE schemaname = 'public'
   ORDER BY idx_scan DESC;
   ```

Document the EXPLAIN ANALYZE output. Verify:
- Query 1 uses idx_visits_client or idx_visits_client_website
- Query 2 uses idx_visits_client_website (composite)
- No sequential scans on large tables

If any query does NOT use an index (sequential scan), note it as a finding. At 1,731 rows PostgreSQL may choose a sequential scan anyway (it's often faster for small tables), so a seq scan is acceptable at current scale — just document it.

Write findings to the SUMMARY.md (no separate audit file needed).
  </action>
  <verify>
EXPLAIN ANALYZE queries executed successfully. Results documented.
  </verify>
  <done>
Index audit complete. EXPLAIN ANALYZE results confirm query plans. Current index coverage is sufficient for all analytics query patterns.
  </done>
</task>

</tasks>

<verification>
1. EXPLAIN ANALYZE executed on main analytics queries
2. Index usage documented
3. No missing indexes identified (or any gaps noted)
</verification>

<success_criteria>
- EXPLAIN ANALYZE confirms index usage on key queries
- No critical missing indexes found
- Audit results documented in SUMMARY.md
</success_criteria>

<output>
After completion, create `.planning/phases/13-database-indexes/13-01-SUMMARY.md`

No git commit for code changes (no files modified).
Commit planning docs only:
```
git add .planning/phases/13-database-indexes/13-01-SUMMARY.md
git commit -m "docs(13-01): complete database index audit"
```
</output>
