---
phase: 17-script-analytics
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - crm-dashboard/components/ui/table.tsx
  - crm-dashboard/components/ScriptAnalytics.tsx
  - crm-dashboard/components/OverallPerformance.tsx
  - crm-dashboard/components/NichePerformance.tsx
  - crm-dashboard/components/ScriptNicheMatrix.tsx
  - crm-dashboard/app/(dashboard)/leads/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees an analytics section on the Cold Calling leads page with date range filter"
    - "User sees overall script performance table showing total calls, success, fail, and win rate per script"
    - "User sees niche performance bar chart showing win rates by niche"
    - "User sees script-niche matrix table showing which scripts work best for which niches"
    - "Scripts with zero outcomes show 'No data yet' instead of NaN or errors"
    - "Inactive scripts appear in analytics with visual distinction (dimmed, '(Inactive)' label)"
    - "Date range filter defaults to 30 days and updates all three views when changed"
  artifacts:
    - path: "crm-dashboard/components/ScriptAnalytics.tsx"
      provides: "Tabbed analytics container with date range state"
      min_lines: 40
    - path: "crm-dashboard/components/OverallPerformance.tsx"
      provides: "Per-script performance table"
      min_lines: 40
    - path: "crm-dashboard/components/NichePerformance.tsx"
      provides: "Per-niche bar chart"
      min_lines: 30
    - path: "crm-dashboard/components/ScriptNicheMatrix.tsx"
      provides: "Script x niche breakdown table"
      min_lines: 30
    - path: "crm-dashboard/components/ui/table.tsx"
      provides: "shadcn Table primitive components"
    - path: "crm-dashboard/app/(dashboard)/leads/page.tsx"
      provides: "Leads page with ScriptAnalytics wired in"
      contains: "ScriptAnalytics"
  key_links:
    - from: "ScriptAnalytics.tsx"
      to: "OverallPerformance, NichePerformance, ScriptNicheMatrix"
      via: "Props: clientId + dateRange"
      pattern: "dateRange.*clientId"
    - from: "OverallPerformance.tsx"
      to: "get_script_outcome_stats RPC"
      via: "supabase.rpc call in useEffect"
      pattern: "supabase\\.rpc.*get_script_outcome_stats"
    - from: "NichePerformance.tsx"
      to: "get_niche_performance_stats RPC"
      via: "supabase.rpc call in useEffect"
      pattern: "supabase\\.rpc.*get_niche_performance_stats"
    - from: "ScriptNicheMatrix.tsx"
      to: "get_script_niche_matrix RPC"
      via: "supabase.rpc call in useEffect"
      pattern: "supabase\\.rpc.*get_script_niche_matrix"
    - from: "leads/page.tsx"
      to: "ScriptAnalytics.tsx"
      via: "Import and render when clientType is leads_only"
      pattern: "ScriptAnalytics.*clientId"
---

<objective>
Build the Script Analytics UI on the Cold Calling leads page with three views: overall performance table, niche performance chart, and script-niche matrix.

Purpose: Enables cold callers to see which scripts perform best overall and within specific business niches, completing the final phase of v1.4.

Output: Four React components + shadcn Table + leads page integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-script-analytics/17-RESEARCH.md
@.planning/phases/17-script-analytics/17-01-SUMMARY.md
@crm-dashboard/types/script.ts
@crm-dashboard/components/ScriptManager.tsx
@crm-dashboard/app/(dashboard)/leads/page.tsx
@crm-dashboard/app/(dashboard)/analytics/components/ShrikeAnalytics.tsx
@crm-dashboard/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn Table and create analytics components</name>
  <files>
    crm-dashboard/components/ui/table.tsx
    crm-dashboard/components/ScriptAnalytics.tsx
    crm-dashboard/components/OverallPerformance.tsx
    crm-dashboard/components/NichePerformance.tsx
    crm-dashboard/components/ScriptNicheMatrix.tsx
  </files>
  <action>
**Step 1: Install shadcn Table component**

Run `npx shadcn@latest add table` inside crm-dashboard/ directory. This creates components/ui/table.tsx with Table, TableBody, TableCell, TableHead, TableHeader, TableRow exports. If the interactive CLI causes issues, manually create the table.tsx file following the shadcn table source (Tailwind-styled HTML table wrappers).

**Step 2: Create OverallPerformance.tsx**

A table showing per-script stats. Props: `{ clientId: string, dateRange: DateRange }`.

- Import ScriptPerformance and DateRange from @/types/script
- Import Table/TableBody/TableCell/TableHead/TableHeader/TableRow from @/components/ui/table
- useState for `stats: ScriptPerformance[]` and `loading: boolean`
- useEffect fetches when clientId or dateRange changes:
  - Convert dateRange to start/end dates using helper function (inline or shared):
    - '7d': now minus 7 days
    - '30d': now minus 30 days
    - '90d': now minus 90 days
    - 'all': null/null
  - Call `supabase.rpc('get_script_outcome_stats', { p_client_id: clientId, p_start_date: start?.toISOString() ?? null, p_end_date: end?.toISOString() ?? null })`
  - Set stats from response

- Empty state: "No scripts yet. Create your first script to start tracking performance."
- Loading state: simple "Loading..." text
- Table columns: Script (name), Total Calls, Success, Fail, Win Rate
- Inactive script rows: `className="opacity-50"` and append "(Inactive)" text in gray after title
- Zero-outcome rows: win rate cell shows "No data yet" in gray italic instead of "0%"
- Success count in green-600, fail count in red-600, win rate font-semibold
- Sort order comes from RPC (total_count DESC, win_rate DESC)

**Step 3: Create NichePerformance.tsx**

A recharts BarChart showing win rates by niche. Props: `{ clientId: string, dateRange: DateRange }`.

- Import NichePerformance type from @/types/script (rename import to avoid name clash: `import type { NichePerformance as NichePerformanceData }`)
- Import BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer from recharts
- useState for `data: NichePerformanceData[]` and `loading: boolean`
- useEffect fetches `get_niche_performance_stats` RPC with same date range conversion pattern
- Filter out niches with total_count === 0 before rendering (bar chart shouldn't show zero bars)
- Empty state (no niches with data): "No niche data yet. Assign niches to leads and record outcomes to see performance by niche."
- Chart: ResponsiveContainer width 100% height 300px, BarChart with CartesianGrid, XAxis on niche_name, YAxis with "Win Rate (%)" label, single Bar on win_rate field, blue fill (#3b82f6)
- Tooltip shows niche name, win rate, total calls

**Step 4: Create ScriptNicheMatrix.tsx**

A grouped table showing script performance within each niche. Props: `{ clientId: string, dateRange: DateRange }`.

- Import ScriptNicheCell and DateRange from @/types/script
- Import Table components from @/components/ui/table
- useState for `data: ScriptNicheCell[]` and `loading: boolean`
- useEffect fetches `get_script_niche_matrix` RPC with date range
- Filter out rows with total_count === 0 (HAVING in RPC removes empty niche-pairs, but additionally filter zero-outcome combos client-side for cleaner display)
- Empty state: "No script-niche data yet. Record outcomes for scripts on leads with assigned niches."
- Render as a flat table with columns: Script, Niche, Total Calls, Success, Fail, Win Rate
- Group visually by script: when script_title changes between rows, add a thicker top border (`border-t-2 border-gray-300`)
- Inactive scripts: same opacity-50 + "(Inactive)" treatment as OverallPerformance
- Zero-outcome cells: "No data yet" in gray italic
- Success in green-600, fail in red-600

**Step 5: Create ScriptAnalytics.tsx**

Container component with date range filter and three tabbed views. Props: `{ clientId: string }`.

- Import DateRange from @/types/script
- Import OverallPerformance, NichePerformance, ScriptNicheMatrix
- useState for dateRange (default: '30d') and activeView ('overall' | 'by-niche' | 'matrix')
- Date range filter: button group styled exactly like ShrikeAnalytics site filter pattern:
  - Container: `flex gap-1 bg-gray-100 rounded-lg p-1`
  - Active button: `bg-white text-gray-900 shadow-sm font-medium`
  - Inactive button: `text-gray-600 hover:text-gray-900`
  - Options: "Last 7 days" (7d), "Last 30 days" (30d), "Last 90 days" (90d), "All time" (all)
- View selector: same button group pattern below the date filter
  - "Overall" | "By Niche" | "By Script + Niche"
- Render the active view component, passing clientId and dateRange
- Section header: "Script Analytics" in text-lg font-semibold

Do NOT use @tanstack/react-table. Plain shadcn Table is sufficient for the small data volumes (typically under 20 rows). Skip the additional dependency.

Create a shared helper function `dateRangeToFilter` used by all three sub-components. Put it inline in each component (3 lines, not worth extracting to a shared file for this).
  </action>
  <verify>
    - crm-dashboard/components/ui/table.tsx exists with Table exports
    - crm-dashboard/components/ScriptAnalytics.tsx exists and imports all three sub-components
    - crm-dashboard/components/OverallPerformance.tsx calls get_script_outcome_stats RPC
    - crm-dashboard/components/NichePerformance.tsx calls get_niche_performance_stats RPC and uses recharts BarChart
    - crm-dashboard/components/ScriptNicheMatrix.tsx calls get_script_niche_matrix RPC
    - All components handle empty states (no data message) and loading states
    - OverallPerformance and ScriptNicheMatrix handle inactive scripts (opacity-50, "(Inactive)" label)
    - Zero-outcome display shows "No data yet" not "0%" or NaN
    - `npm run build` passes
  </verify>
  <done>Five files created: shadcn Table primitive, ScriptAnalytics container with date range filter and view tabs, OverallPerformance table, NichePerformance bar chart, ScriptNicheMatrix grouped table. All handle empty/zero/inactive states. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ScriptAnalytics into leads page</name>
  <files>crm-dashboard/app/(dashboard)/leads/page.tsx</files>
  <action>
Add the ScriptAnalytics section to the Cold Calling leads page, below the existing Call Scripts section and above the Leads Table.

1. Add import: `import { ScriptAnalytics } from '@/components/ScriptAnalytics'`

2. Add state for analytics section visibility: `const [analyticsExpanded, setAnalyticsExpanded] = useState(false)` (default collapsed -- analytics is secondary to the leads workflow, user expands when needed)

3. After the Call Scripts section (the `{currentClientId && (...)}` block ending around line 298) and before the Leads Table section (the `{/* Leads Table */}` comment), add:

```tsx
{/* Script Analytics Section */}
{currentClientId && (
  <div className="bg-white rounded-lg shadow mb-6">
    <button
      onClick={() => setAnalyticsExpanded(!analyticsExpanded)}
      className="w-full flex items-center justify-between px-6 py-4 text-left"
    >
      <h2 className="text-lg font-semibold text-gray-900">Script Analytics</h2>
      <span className="text-gray-400 text-sm">
        {analyticsExpanded ? 'Hide' : 'Show'}
      </span>
    </button>
    {analyticsExpanded && (
      <div className="px-6 pb-6">
        <ScriptAnalytics clientId={currentClientId} />
      </div>
    )}
  </div>
)}
```

This follows the exact same collapsible pattern used for the Call Scripts section above it (same button style, same px-6 py-4 padding, same text-lg font-semibold header).

Do NOT add any conditional logic based on client_type. The leads page is already only accessible to the Cold Calling client (client_type filtering happens in the sidebar navigation per Phase 6). The analytics section simply renders when currentClientId exists, same as Call Scripts.
  </action>
  <verify>
    - leads/page.tsx imports ScriptAnalytics
    - ScriptAnalytics renders inside a collapsible section below Call Scripts
    - analyticsExpanded state defaults to false (collapsed)
    - Collapsible pattern matches Call Scripts section (same classNames, same button structure)
    - `npm run build` passes with no errors
  </verify>
  <done>ScriptAnalytics section appears on the Cold Calling leads page as a collapsible section below Call Scripts. Default collapsed. Build passes.</done>
</task>

</tasks>

<verification>
Phase 17 Success Criteria verification:

1. "Cold Calling analytics view shows overall script performance table" -- OverallPerformance.tsx renders table with total calls, success count, fail count, success rate per script
2. "Analytics view shows performance breakdown by niche" -- NichePerformance.tsx renders recharts BarChart with win rates by niche
3. "Analytics view shows script-within-niche matrix" -- ScriptNicheMatrix.tsx renders grouped table with script x niche breakdown
4. "Scripts with zero outcomes display gracefully" -- All three components show "No data yet" for zero-outcome entities, empty states for no data at all
5. "Date range filter allows comparison" -- ScriptAnalytics.tsx has 7d/30d/90d/all button group, default 30d, passed to all sub-components

Additional checks:
- Inactive scripts visible with opacity-50 and "(Inactive)" label
- No NaN or division-by-zero errors (handled in RPC + UI layer)
- `npm run build` passes
</verification>

<success_criteria>
1. ScriptAnalytics section visible on Cold Calling leads page (collapsible, default collapsed)
2. Overall performance table shows all scripts with stats columns
3. Niche performance bar chart renders when niche data exists
4. Script-niche matrix table shows grouped breakdown
5. Date range filter updates all three views
6. Zero-outcome entities show "No data yet" gracefully
7. Inactive scripts visually distinguished
8. npm run build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-script-analytics/17-02-SUMMARY.md`
</output>
