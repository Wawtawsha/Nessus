---
phase: 17-script-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crm-dashboard/supabase/migrations/09_script_analytics_rpcs.sql
  - crm-dashboard/types/script.ts
autonomous: true

must_haves:
  truths:
    - "get_script_outcome_stats RPC accepts optional date range parameters and returns script_title + is_active"
    - "get_niche_performance_stats RPC returns per-niche aggregation scoped by client"
    - "get_script_niche_matrix RPC returns script x niche cross-tabulation with outcome stats"
    - "All three RPCs return 0 counts for entities with no outcomes in the date range (LEFT JOIN preserved)"
    - "Inactive scripts appear in analytics RPC results (no is_active filter)"
  artifacts:
    - path: "crm-dashboard/supabase/migrations/09_script_analytics_rpcs.sql"
      provides: "Three RPC functions for script analytics"
      contains: "get_script_outcome_stats"
    - path: "crm-dashboard/types/script.ts"
      provides: "Analytics-specific TypeScript interfaces"
      contains: "ScriptPerformance"
  key_links:
    - from: "09_script_analytics_rpcs.sql"
      to: "scripts table"
      via: "LEFT JOIN with date filter in ON clause"
      pattern: "LEFT JOIN script_lead_outcomes"
    - from: "09_script_analytics_rpcs.sql"
      to: "niches table"
      via: "LEFT JOIN through leads"
      pattern: "LEFT JOIN leads.*niche_id"
    - from: "types/script.ts"
      to: "09_script_analytics_rpcs.sql"
      via: "Interface fields match RPC return columns"
      pattern: "script_title.*niche_name.*win_rate"
---

<objective>
Create the three PostgreSQL RPC functions needed for script analytics and add corresponding TypeScript types.

Purpose: Provides the server-side aggregation layer that the analytics UI will call. All three RPCs support optional date range filtering and preserve zero-outcome entities via LEFT JOIN patterns.

Output: Migration file with 3 RPCs + updated TypeScript types file
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-script-analytics/17-RESEARCH.md
@crm-dashboard/supabase/migrations/08_script_outcome_stats.sql
@crm-dashboard/supabase/migrations/07_scripts_niches_outcomes.sql
@crm-dashboard/types/script.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics RPC migration</name>
  <files>crm-dashboard/supabase/migrations/09_script_analytics_rpcs.sql</files>
  <action>
Create a new migration file with three RPC functions. All three use SECURITY DEFINER, accept p_client_id UUID + optional p_start_date/p_end_date TIMESTAMPTZ (DEFAULT NULL), and follow the established patterns from 08_script_outcome_stats.sql.

**Function 1: Replace get_script_outcome_stats**

Use CREATE OR REPLACE to upgrade the existing function. Changes from Phase 16 version:
- Add parameters: p_start_date TIMESTAMPTZ DEFAULT NULL, p_end_date TIMESTAMPTZ DEFAULT NULL
- Add to RETURNS TABLE: script_title TEXT, is_active BOOLEAN
- REMOVE the `AND s.is_active = true` WHERE clause (analytics shows ALL scripts including inactive)
- Move date filtering into the LEFT JOIN ON clause (NOT in WHERE): `AND (p_start_date IS NULL OR o.created_at >= p_start_date) AND (p_end_date IS NULL OR o.created_at <= p_end_date)`
- Add `s.title AS script_title` and `s.is_active` to SELECT
- GROUP BY s.id, s.title, s.is_active
- ORDER BY total_count DESC, win_rate DESC (not created_at DESC -- analytics sorts by performance)

Keep: COUNT(o.id) for total_count, COALESCE+FILTER for success/fail, division-by-zero CASE guard.

IMPORTANT: The old function signature is `get_script_outcome_stats(UUID)`. The new one is `get_script_outcome_stats(UUID, TIMESTAMPTZ, TIMESTAMPTZ)`. PostgreSQL treats these as different overloads. You MUST first DROP the old single-parameter version, then CREATE the new three-parameter version. Otherwise, ScriptManager.tsx (which calls with only p_client_id) will get ambiguous function errors. Use:
```sql
DROP FUNCTION IF EXISTS get_script_outcome_stats(UUID);
```
before CREATE OR REPLACE.

The new function's p_start_date and p_end_date have DEFAULT NULL, so callers passing only p_client_id will still work (dates default to NULL = all time).

**Function 2: Create get_niche_performance_stats**

New function. Returns: niche_id UUID, niche_name TEXT, success_count BIGINT, fail_count BIGINT, total_count BIGINT, win_rate NUMERIC.

Join chain: niches n LEFT JOIN leads l ON l.niche_id = n.id LEFT JOIN script_lead_outcomes o ON o.lead_id = l.id. Date filter in the outcomes LEFT JOIN ON clause.

Scope to client via WHERE EXISTS (SELECT 1 FROM leads WHERE niche_id = n.id AND client_id = p_client_id). This ensures only niches used by the client's leads are returned.

Same aggregation pattern: COUNT(o.id), COALESCE+FILTER, division-by-zero guard.
ORDER BY total_count DESC, win_rate DESC.

**Function 3: Create get_script_niche_matrix**

New function. Returns: script_id UUID, script_title TEXT, niche_id UUID, niche_name TEXT, success_count BIGINT, fail_count BIGINT, total_count BIGINT, win_rate NUMERIC.

Join: scripts s CROSS JOIN niches n LEFT JOIN leads l ON l.niche_id = n.id AND l.client_id = p_client_id LEFT JOIN script_lead_outcomes o ON o.script_id = s.id AND o.lead_id = l.id (with date filter on o.created_at in this ON clause).

WHERE s.client_id = p_client_id.
HAVING COUNT(l.id) > 0 (only show script-niche pairs where client has leads in that niche).
ORDER BY s.title, n.name.

Same aggregation pattern as the other functions.

Add COMMENT ON FUNCTION for all three.
  </action>
  <verify>
    - File exists at crm-dashboard/supabase/migrations/09_script_analytics_rpcs.sql
    - Contains DROP FUNCTION IF EXISTS get_script_outcome_stats(UUID)
    - Contains CREATE OR REPLACE FUNCTION get_script_outcome_stats with 3 params
    - Contains CREATE OR REPLACE FUNCTION get_niche_performance_stats with 3 params
    - Contains CREATE OR REPLACE FUNCTION get_script_niche_matrix with 3 params
    - All three have SECURITY DEFINER
    - All three have date filter in LEFT JOIN ON clause (not WHERE)
    - All three have COUNT(o.id) for total_count
    - get_script_outcome_stats does NOT have is_active = true in WHERE
    - get_script_outcome_stats returns script_title and is_active columns
    - `npm run build` in crm-dashboard still passes (migration is SQL-only, no TS impact yet)
  </verify>
  <done>Three RPC functions defined in migration file, ready to deploy to Supabase. Old single-param function dropped to avoid overload ambiguity.</done>
</task>

<task type="auto">
  <name>Task 2: Add analytics TypeScript types</name>
  <files>crm-dashboard/types/script.ts</files>
  <action>
Add three new interfaces to the existing script.ts file (append after ScriptOutcome):

1. **ScriptPerformance** — matches get_script_outcome_stats return:
```typescript
export interface ScriptPerformance {
  script_id: string
  script_title: string
  is_active: boolean
  success_count: number
  fail_count: number
  total_count: number
  win_rate: number
}
```

2. **NichePerformance** — matches get_niche_performance_stats return:
```typescript
export interface NichePerformance {
  niche_id: string
  niche_name: string
  success_count: number
  fail_count: number
  total_count: number
  win_rate: number
}
```

3. **ScriptNicheCell** — matches get_script_niche_matrix return:
```typescript
export interface ScriptNicheCell {
  script_id: string
  script_title: string
  niche_id: string
  niche_name: string
  success_count: number
  fail_count: number
  total_count: number
  win_rate: number
}
```

4. **DateRange type** — shared across analytics components:
```typescript
export type DateRange = '7d' | '30d' | '90d' | 'all'
```

Do NOT modify existing interfaces (Script, OutcomeStats, ScriptWithStats, ScriptOutcome). They are used by ScriptManager and ScriptCard.

Note: The existing OutcomeStats interface does NOT have script_title or is_active. The new ScriptPerformance interface is a superset for analytics use. Both will coexist — OutcomeStats is used by ScriptManager's client-side join, ScriptPerformance is used by the analytics view directly.
  </action>
  <verify>
    - crm-dashboard/types/script.ts contains ScriptPerformance, NichePerformance, ScriptNicheCell, DateRange
    - Existing exports (Script, OutcomeStats, ScriptWithStats, ScriptOutcome) unchanged
    - `npm run build` in crm-dashboard passes with no type errors
  </verify>
  <done>TypeScript types for all three analytics RPCs and shared DateRange type exported from types/script.ts. Build passes.</done>
</task>

</tasks>

<verification>
- Migration file has 3 functions with consistent patterns (SECURITY DEFINER, LEFT JOIN, COUNT(o.id), division guard)
- TypeScript types match RPC return columns exactly (field names, types)
- No breaking changes to existing ScriptManager/ScriptCard (OutcomeStats still works)
- Build passes
</verification>

<success_criteria>
1. Migration file exists with three well-documented RPC functions
2. All RPCs accept optional date range parameters
3. Inactive scripts included in get_script_outcome_stats (no is_active filter)
4. TypeScript types match RPC return signatures
5. npm run build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-script-analytics/17-01-SUMMARY.md`
</output>
