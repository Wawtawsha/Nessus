# Milestone v1.3: Analytics Deep Dive

**Status:** SHIPPED 2026-02-15
**Phases:** 9-13
**Total Plans:** 6

## Overview

Surface deep visitor insights — session journeys, geographic distribution, referrer quality, and scroll engagement — building on the existing ShrikeAnalytics dashboard. Component architecture refactored first (Phase 9), then 3 analytics sections added to Deep Dive tab, concluding with a database index audit.

## Phases

### Phase 9: Component Decomposition

**Goal:** Refactor ShrikeAnalytics from monolith to thin tab container with autonomous section components
**Depends on:** Phase 5 (Shrike Consolidation)
**Plans:** 1 plan

Plans:
- [x] 09-01: Extract shared components + 8 section components from ShrikeAnalytics

**Details:**
- Reduced ShrikeAnalytics.tsx from 606 lines (11 state vars) to 130 lines (4 state vars)
- Created 8 section components, each computing from raw visits via useMemo
- Established section component pattern: `function SectionName({ visits }: { visits: Visit[] })`
- Created shared library: StatCard, BreakdownCard, types.ts, constants.ts
- Added Overview/Deep Dive tab layout

### Phase 10: Session Journeys + Time on Page

**Goal:** Visualize session-level visitor behavior with chronological event timelines and page duration metrics
**Depends on:** Phase 9 (section component pattern)
**Plans:** 1 plan

Plans:
- [x] 10-01: Create SessionJourneys and TimeOnPage section components

**Details:**
- SessionJourneys: groups visits by session_id, displays chronological event timelines with duration and event count
- TimeOnPage: calculates average page durations from consecutive timestamp deltas within sessions
- Last-page exclusion (no exit timestamp), 30-minute duration cap (abandoned tabs)
- Deep Dive tab functional with real analytics

### Phase 11: Referrer Analysis + Geo Distribution

**Goal:** Show which traffic sources drive engaged visitors and where visitors are located
**Depends on:** Phase 10 (Deep Dive tab with section components)
**Plans:** 1 plan

Plans:
- [x] 11-01: Create ReferrerAnalysis and GeoDistribution section components

**Details:**
- ReferrerAnalysis: 5 source categories (Direct, Facebook, Instagram, Self-referral, Other) with fbclid-first precedence
- Engagement quality metric: avg events/session per referrer source
- GeoDistribution: top 15 cities with US state abbreviations ("Farmville, VA")
- Extended Visit interface with 6 geo fields (referrer, country, city, region, latitude, longitude)

### Phase 12: Scroll Depth

**Goal:** Capture scroll behavior on Shrike website and visualize per-page milestone achievement rates in CRM
**Depends on:** Phase 11 (Deep Dive tab with section components)
**Plans:** 2 plans

Plans:
- [x] 12-01: Add IntersectionObserver scroll depth tracking to Shrike website
- [x] 12-02: Create ScrollDepth section component in CRM dashboard

**Details:**
- IntersectionObserver with pixel-based sentinel positioning (not CSS %)
- 5 milestones tracked: 25%, 50%, 75%, 90%, 100%
- Set-based deduplication prevents duplicate fires on scroll up/down
- Short page guard skips tracking on pages already fully visible
- Achievement rates use page view sessions as denominator
- Cross-repo implementation: Shrike website + Nessus CRM dashboard

### Phase 13: Database Indexes

**Goal:** Audit database indexes and verify coverage for all analytics query patterns
**Depends on:** Phase 12 (all analytics features complete)
**Plans:** 1 plan

Plans:
- [x] 13-01: Run EXPLAIN ANALYZE on key analytics queries and document results

**Details:**
- All FK columns across 5 tables have B-tree indexes (100% coverage)
- Composite idx_visits_client_website used for site-filtered queries (4.6ms)
- PostgreSQL correctly chose seq scan for unfiltered query (98.4% selectivity)
- v1.4 indexes pre-created and ready for Phase 15+ data

---

## Milestone Summary

**Key Decisions:**
- Section components compute from raw visits (not pre-computed state) — prevents prop drilling
- useMemo for all section computations — prevents recalculation on tab switching
- Time deltas within sessions only (never across boundaries) — prevents impossible durations
- 30-minute cap on page durations — excludes abandoned tabs
- fbclid tracking param checked FIRST in referrer categorization — correct Facebook attribution
- IntersectionObserver over scroll event listeners — 43% less CPU, off-main-thread
- Achievement rates use page view sessions as denominator — accurate representation

**Issues Resolved:**
- Plan checker found 3 documentation inconsistencies in Phase 12 plans (positioning guidance, event_data structure, key_links) — all fixed before execution

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---
_For current project status, see .planning/ROADMAP.md_
