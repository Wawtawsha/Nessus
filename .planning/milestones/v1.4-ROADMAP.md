# Milestone v1.4: Cold Calling Scripts

**Status:** SHIPPED 2026-02-16
**Phases:** 14-17
**Total Plans:** 7

## Overview

Equip cold callers with managed call scripts, track per-lead outcomes (success/fail), and surface analytics on which scripts perform best overall and within business niches.

## Phases

### Phase 14: Schema + Niche Taxonomy

**Goal:** Users can create, manage, and assign business niches to leads for categorization
**Depends on:** v1.2 Lead Management (Cold Calling client, Add Lead form, Edit Lead inline mode)
**Requirements:** SCRIPT-03
**Plans:** 2 plans

Plans:
- [x] 14-01-PLAN.md — Database migration (niches, scripts, outcomes tables) + TypeScript types
- [x] 14-02-PLAN.md — NicheComboBox component + leads page/detail integration

**Success Criteria:**
1. Database tables exist for scripts, niches, and script_lead_outcomes with RLS policies, indexes, and proper foreign key cascade behavior
2. User can create new niches via a searchable combo selector (type to search, create inline if not found)
3. User can assign a niche to a lead when adding or editing a lead on the Cold Calling page
4. Niche names are normalized (lowercase, trimmed) and enforced unique at the database level
5. Leads table displays niche column and supports filtering by niche

### Phase 15: Script Library CRUD

**Goal:** Users can create, edit, and manage call scripts directly from the Cold Calling page
**Depends on:** Phase 14 (scripts table exists)
**Requirements:** SCRIPT-01
**Plans:** 1 plan

Plans:
- [x] 15-01-PLAN.md — Script CRUD components (ScriptManager, ScriptCard, AddEditScriptDialog) + leads page integration

**Success Criteria:**
1. User can create a new script with title and body from the Cold Calling leads page
2. User can edit an existing script (title, body, active/inactive toggle)
3. Script list displays on the Cold Calling leads page with script cards showing title and status
4. User can read a script in a clean, mobile-optimized view suitable for reference during a call
5. Only active scripts show by default; inactive scripts are hidden but not deleted

### Phase 16: Outcome Tracking

**Goal:** Users can record per-lead call outcomes (success/fail) tied to a specific script
**Depends on:** Phase 15 (scripts exist to select from)
**Requirements:** SCRIPT-02
**Plans:** 2 plans

Plans:
- [x] 16-01-PLAN.md — RPC aggregation function + TypeScript types + Zod outcome schema
- [x] 16-02-PLAN.md — RecordOutcomeDialog + ScriptCard stats + ScriptManager integration

**Success Criteria:**
1. User can open a script call dialog, select a lead, and mark the outcome as success or fail with large phone-friendly buttons (48x48px minimum)
2. Each outcome is permanently linked to both a lead and a script
3. If an outcome already exists for a script+lead pair, the previous result is shown and can be updated (upsert behavior)
4. Script cards display aggregated counters (success count, fail count, win rate percentage)
5. User can add optional notes when recording an outcome

### Phase 17: Script Analytics

**Goal:** Users can see which scripts perform best overall and within specific business niches
**Depends on:** Phase 16 (outcomes exist to analyze)
**Requirements:** SCRIPT-04
**Plans:** 2 plans

Plans:
- [x] 17-01-PLAN.md — Analytics RPC functions (3 RPCs with date range) + TypeScript types
- [x] 17-02-PLAN.md — Analytics UI (OverallPerformance table, NichePerformance chart, ScriptNicheMatrix, leads page integration)

**Success Criteria:**
1. Cold Calling analytics view shows overall script performance table
2. Analytics view shows performance breakdown by niche
3. Analytics view shows script-within-niche matrix
4. Scripts with zero outcomes display gracefully ("No data yet")
5. Date range filter (7d / 30d / 90d / all) allows comparison

---

## Milestone Summary

**Key Decisions:**
- All 3 tables (scripts, niches, script_lead_outcomes) created in single migration
- Niche names normalized to lowercase with UNIQUE constraint
- Soft delete for scripts (is_active flag)
- niche_id on leads uses ON DELETE SET NULL (not CASCADE)
- UNIQUE(script_id, lead_id) on script_lead_outcomes enables upsert
- RLS policies scope scripts through user_clients join
- Script outcome is binary success/fail for MVP
- mode:'onSubmit' for RHF inside shadcn Dialog
- Dialog state machine (closed/add/edit/view/record-outcome)
- LEFT JOIN in RPCs with date filter in ON clause (not WHERE)
- COUNT(o.id) not COUNT(*) for accurate zero-outcome counts
- DROP old RPC signature before CREATE OR REPLACE with new params
- Default collapsed for analytics section
- Visual grouping in ScriptNicheMatrix via border styling

**Issues Resolved:**
- Radix Popover z-index bug behind native dialogs (used relative dropdown instead)
- PostgreSQL overload ambiguity with DEFAULT params (DROP old signature first)
- ScriptNicheMatrix missing is_active (fixed in verification gap closure)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None significant

---

_For current project status, see .planning/ROADMAP.md_
